<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confabuletition | AG001: repetition as "confabulation"</title>
  <link rel="stylesheet" href="../page-theme.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Courier+Prime&display=swap" rel="stylesheet">
  <style>
:root{
  /* Align with arcade noir palette (page-theme.css) */
  --bg: #0a0a0a;
  --fg: #7ec8e3;
  --muted: rgba(126,200,227,.72);
  --panel: rgba(255,255,255,.05);
  --stroke: rgba(126,200,227,.18);
  --accent: #00ffff;
  --accent-glow: rgba(0,255,255,.15);

  --size: 18px;
  --opacity: 0.6;
  --blur: 0.6px;
}

*{ box-sizing: border-box; }
html, body{ height: 100%; }
body{
  margin: 0;
  font-family: 'Courier Prime', 'Courier New', monospace;
  background: var(--bg);
  color: var(--fg);
}

.skip{
  position: absolute;
  left: -9999px;
  top: 0;
}
.skip:focus{
  left: 12px;
  top: 12px;
  z-index: 9999;
  padding: 10px 12px;
  background: var(--bg);
  border: 1px solid var(--stroke);
  border-radius: 12px;
}

.home-link{
  position: fixed;
  top: 12px;
  left: 12px;
  z-index: 100;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.4);
  border: 1px solid var(--stroke);
  border-radius: 8px;
  color: var(--accent);
  text-decoration: none;
  font-size: 1.4rem;
  transition: background 0.2s, border-color 0.2s;
}
.home-link:hover{
  background: rgba(100,200,220,.15);
  border-color: var(--accent);
}

.frame{
  padding: 18px 18px 0 60px;
  max-width: 1200px;
  margin: 0 auto;
}
.frame h1{
  font-size: clamp(18px, 2.2vw, 24px);
  margin: 0 0 8px 0;
  color: var(--accent);
  text-shadow: 0 0 20px var(--accent-glow);
}
.frame p{
  margin: 0 0 10px 0;
  color: var(--muted);
  line-height: 1.4;
  max-width: 76ch;
  font-size: 0.95rem;
}

.layout{
  display: grid;
  grid-template-columns: 1fr minmax(280px, 360px);
  gap: 14px;
  padding: 18px;
  max-width: 1200px;
  margin: 0 auto;
}

.stage{
  position: relative;
  min-height: 72vh;
  border: 1px solid var(--stroke);
  border-radius: 14px;
  overflow: hidden;
  background: radial-gradient(1200px 600px at 30% 10%, var(--accent-glow), transparent 60%),
              linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
}

.stageTop{
  position: absolute;
  top: 12px;
  left: 12px;
  right: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
  z-index: 5;
  pointer-events: none;
}

.status{
  display: flex;
  gap: 10px;
  align-items: center;
  pointer-events: none;
}
.pill{
  display: inline-flex;
  align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  font-size: .85rem;
}
.small{
  font-size: .85rem;
  color: rgba(224,232,240,.72);
}

.actions{
  display: flex;
  gap: 8px;
  pointer-events: auto;
  flex-wrap: wrap;
}

.rain{
  position: absolute;
  inset: 0;
  overflow: hidden;
}

.stageBottom{
  position: absolute;
  left: 12px;
  right: 12px;
  bottom: 12px;
  display: grid;
  gap: 10px;
  z-index: 5;
  pointer-events: none;
}

.meter{
  display: grid;
  grid-template-columns: auto 1fr auto;
  gap: 10px;
  align-items: center;
  pointer-events: none;
}

.bar{
  height: 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.35);
  overflow: hidden;
}
.fill{
  height: 100%;
  width: 0%;
  background: linear-gradient(90deg, var(--accent), rgba(220,100,120,.85));
}

.hint{
  margin: 0;
  font-size: .82rem;
  color: rgba(224,232,240,.55);
}
.hint .sportello{
  color: var(--accent);
  opacity: 0.7;
}

.panel{
  border: 1px solid var(--stroke);
  border-radius: 14px;
  padding: 14px;
  background: var(--panel);
}
.panel h2{
  margin: 0 0 10px 0;
  font-size: 1rem;
  color: var(--accent);
}

.ui{ display: grid; gap: 10px; }

.field{
  display: grid;
  gap: 5px;
}
.field span{
  font-size: 0.85rem;
  color: rgba(224,232,240,.75);
}
.field textarea{
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  color: var(--fg);
  font-family: inherit;
  resize: vertical;
  min-height: 46px;
}
.field input[type="range"]{ width: 100%; accent-color: var(--accent); }
.field output{
  font-size: 0.82rem;
  color: rgba(224,232,240,.65);
}
.field select{
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  color: var(--fg);
  font-family: inherit;
}

.grid2{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  align-items: end;
}

.inline{
  grid-template-columns: 18px 1fr;
  align-items: center;
  gap: 10px;
}

.row{
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

details.help{
  border: 1px solid rgba(255,255,255,.08);
  border-radius: 10px;
  padding: 10px 12px;
  background: rgba(0,0,0,.2);
}
details.help summary{
  cursor: pointer;
  color: rgba(224,232,240,.8);
  font-size: 0.9rem;
}
details.help p{
  margin: 10px 0 0 0;
  color: rgba(224,232,240,.6);
  line-height: 1.4;
  font-size: 0.85rem;
}

button{
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  color: var(--fg);
  padding: 8px 12px;
  border-radius: 10px;
  cursor: pointer;
  font-family: inherit;
  font-size: 0.85rem;
  transition: background 0.2s, border-color 0.2s;
}
button:hover{
  background: rgba(100,200,220,.1);
  border-color: var(--accent);
}
button:focus-visible{
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.stream{
  position: absolute;
  top: -140%;
  width: max-content;
  max-width: 36ch;
  font-size: var(--size);
  line-height: 1.15;
  opacity: var(--opacity);
  filter: blur(var(--blur));
  text-shadow: 0 0 12px var(--accent-glow);
  animation-name: fall, sway;
  animation-timing-function: linear, ease-in-out;
  animation-iteration-count: infinite, infinite;
  will-change: transform;
  user-select: none;
  pointer-events: none;
}

.stream.wrap{
  max-width: 34ch;
  white-space: normal;
}

.stream .line{
  display: block;
  padding: 2px 0;
  white-space: nowrap;
}
.stream.wrap .line{
  white-space: normal;
}

@keyframes fall{
  from{ transform: translate3d(0, -15vh, 0); }
  to{ transform: translate3d(0, 118vh, 0); }
}

@keyframes sway{
  0%{ margin-left: calc(var(--sway) * -1px); }
  50%{ margin-left: calc(var(--sway) * 1px); }
  100%{ margin-left: calc(var(--sway) * -1px); }
}

.paused .stream{
  animation-play-state: paused, paused;
}

.reader{
  max-width: 1200px;
  margin: 0 auto;
  padding: 0 18px 18px 18px;
}
.reader h2{
  margin: 8px 0 8px 0;
  font-size: 1rem;
  color: var(--accent);
}
.reader p{
  margin: 0 0 10px 0;
  color: var(--muted);
  max-width: 76ch;
  font-size: 0.9rem;
}
.reader pre{
  margin: 0;
  padding: 14px;
  border-radius: 12px;
  border: 1px solid var(--stroke);
  background: rgba(0,0,0,.35);
  color: var(--fg);
  overflow: auto;
  max-height: 48vh;
  line-height: 1.35;
  font-family: inherit;
}

.srOnly{
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  overflow: hidden;
}

body.invert{
  --bg: #f4f6f8;
  --fg: #0a0c10;
  --muted: rgba(10,12,16,.72);
  --panel: rgba(0,0,0,.04);
  --stroke: rgba(0,0,0,.12);
  --accent: rgba(60,140,160,.95);
  --accent-glow: rgba(60,140,160,.15);
}

@media (max-width: 900px){
  .layout{ grid-template-columns: 1fr; }
  .stage{ min-height: 58vh; }
  .frame{ padding-left: 60px; }
}

@media (max-width: 480px){
  .actions{ gap: 6px; }
  button{ padding: 8px 10px; font-size: 0.8rem; }
  .grid2{ grid-template-columns: 1fr; }
}

@media (prefers-reduced-motion: reduce){
  .stream{
    animation-duration: 999999s, 999999s !important;
  }
}
  </style>
</head>
<body>
  <a href="../index.html" class="home-link">‚Üê</a>
  <a class="skip" href="#controls">Skip to controls</a>

  <header class="frame" aria-label="Framing">
    <h1>AG001: repetition as "confabulation"</h1>
    <p>
      The sentence repeats until it becomes a system behavior. Streams fall, copy, and slightly corrupt
      themselves. The interface keeps the phrase present while showing what repetition does to it.
    </p>
  </header>

  <main class="layout">
    <section class="stage" aria-label="Visualization stage">
      <div class="stageTop">
        <div class="status" aria-live="polite">
          <span class="pill" id="statusPill">Running</span>
          <span class="small" id="statsText">0 streams</span>
        </div>

        <div class="actions">
          <button id="togglePause" type="button">Pause</button>
          <button id="regen" type="button">Regenerate</button>
          <button id="reset" type="button">Reset</button>
          <button id="readerMode" type="button" aria-pressed="false">Reader mode</button>
        </div>
      </div>

      <div
        id="rain"
        class="rain"
        role="img"
        aria-label="Repeated text streams falling downward"
        tabindex="0"
      ></div>

      <div class="stageBottom">
        <div class="meter" aria-label="Confabulation meter">
          <span class="small">Confabulation</span>
          <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
            <div class="fill" id="hallucFill"></div>
          </div>
          <span class="small" id="hallucPct">0%</span>
        </div>

        <p class="hint">
          Click to drop a burst. Space to pause/resume. C to copy reader text.
          <span class="sportello">// Bot Sportello exhibit</span>
        </p>
      </div>
    </section>

    <aside class="panel" id="controls" aria-label="Controls">
      <h2>Controls</h2>

      <form id="ui" class="ui" autocomplete="off">
        <label class="field">
          <span>Source phrase</span>
          <textarea id="phrase" rows="2">Schools don't just happen to exist</textarea>
        </label>

        <div class="grid2">
          <label class="field">
            <span>Speed</span>
            <input id="speed" type="range" min="1" max="20" step="1" value="10" />
            <output id="speedOut" for="speed">10</output>
          </label>

          <label class="field">
            <span>Density</span>
            <input id="density" type="range" min="6" max="80" step="1" value="28" />
            <output id="densityOut" for="density">28</output>
          </label>
        </div>

        <div class="grid2">
          <label class="field">
            <span>Font size</span>
            <input id="size" type="range" min="12" max="38" step="1" value="18" />
            <output id="sizeOut" for="size">18</output>
          </label>

          <label class="field">
            <span>Opacity</span>
            <input id="opacity" type="range" min="0.15" max="1" step="0.05" value="0.6" />
            <output id="opacityOut" for="opacity">0.6</output>
          </label>
        </div>

        <div class="grid2">
          <label class="field">
            <span>Text glitch</span>
            <input id="glitch" type="range" min="0" max="1" step="0.05" value="0.2" />
            <output id="glitchOut" for="glitch">0.2</output>
          </label>

          <label class="field">
            <span>Horizontal drift</span>
            <input id="drift" type="range" min="0" max="22" step="1" value="10" />
            <output id="driftOut" for="drift">10</output>
          </label>
        </div>

        <div class="grid2">
          <label class="field">
            <span>Blur</span>
            <input id="blur" type="range" min="0" max="3" step="0.1" value="0.6" />
            <output id="blurOut" for="blur">0.6</output>
          </label>

          <label class="field">
            <span>Wrap lines</span>
            <select id="wrap">
              <option value="off" selected>Off</option>
              <option value="on">On</option>
            </select>
          </label>
        </div>

        <label class="field inline">
          <input id="invert" type="checkbox" />
          <span>Invert (light background)</span>
        </label>

        <details class="help">
          <summary>How "text glitch" works</summary>
          <p>
            The system copies the phrase with small errors: doubled words, swapped letters, dropped marks.
            It keeps the phrase recognizable while making the repetition visible as drift and decay.
          </p>
        </details>

        <div class="row">
          <button id="copyReader" type="button">Copy reader text</button>
        </div>

        <div class="srOnly" aria-live="polite" id="srStatus"></div>
      </form>
    </aside>
  </main>

  <section class="reader" id="reader" hidden aria-label="Reader mode">
    <h2>Reader mode (static)</h2>
    <p>
      This view pauses motion and renders a block of repeated text for quoting or annotation.
    </p>
    <pre id="readerText" aria-label="Repeated text block"></pre>
  </section>

  <script>
(() => {
  const rain = document.getElementById("rain");
  const ui = document.getElementById("ui");

  const phraseEl = document.getElementById("phrase");
  const speedEl = document.getElementById("speed");
  const densityEl = document.getElementById("density");
  const sizeEl = document.getElementById("size");
  const opacityEl = document.getElementById("opacity");
  const glitchEl = document.getElementById("glitch");
  const driftEl = document.getElementById("drift");
  const blurEl = document.getElementById("blur");
  const wrapEl = document.getElementById("wrap");
  const invertEl = document.getElementById("invert");

  const speedOut = document.getElementById("speedOut");
  const densityOut = document.getElementById("densityOut");
  const sizeOut = document.getElementById("sizeOut");
  const opacityOut = document.getElementById("opacityOut");
  const glitchOut = document.getElementById("glitchOut");
  const driftOut = document.getElementById("driftOut");
  const blurOut = document.getElementById("blurOut");

  const togglePauseBtn = document.getElementById("togglePause");
  const regenBtn = document.getElementById("regen");
  const resetBtn = document.getElementById("reset");
  const readerBtn = document.getElementById("readerMode");
  const copyReaderBtn = document.getElementById("copyReader");

  const reader = document.getElementById("reader");
  const readerText = document.getElementById("readerText");

  const srStatus = document.getElementById("srStatus");
  const statusPill = document.getElementById("statusPill");
  const statsText = document.getElementById("statsText");

  const hallucFill = document.getElementById("hallucFill");
  const hallucPct = document.getElementById("hallucPct");
  const hallucBar = hallucFill.parentElement;

  const prefersReducedMotion = window.matchMedia &&
    window.matchMedia("(prefers-reduced-motion: reduce)").matches;

  const state = {
    paused: false,
    readerMode: false,
    phrase: phraseEl.value.trim(),
    speed: Number(speedEl.value),
    density: Number(densityEl.value),
    size: Number(sizeEl.value),
    opacity: Number(opacityEl.value),
    glitch: Number(glitchEl.value),
    drift: Number(driftEl.value),
    blur: Number(blurEl.value),
    wrap: wrapEl.value
  };

  let halluc = 0;

  function clamp(n, min, max){ return Math.max(min, Math.min(max, n)); }
  function chance(p){ return Math.random() < p; }

  function setRootVar(name, value){
    document.documentElement.style.setProperty(name, String(value));
  }

  function announce(msg){
    srStatus.textContent = msg;
  }

  function updateOutputs(){
    speedOut.textContent = String(state.speed);
    densityOut.textContent = String(state.density);
    sizeOut.textContent = String(state.size);
    opacityOut.textContent = String(state.opacity);
    glitchOut.textContent = String(state.glitch);
    driftOut.textContent = String(state.drift);
    blurOut.textContent = String(state.blur);
  }

  function computeDuration(speed){
    const s = clamp(speed, 1, 20);
    return (26 - (s - 1) * (20 / 19));
  }

  function escapeHtml(str){
    return str
      .replaceAll("&", "&amp;")
      .replaceAll("<", "&lt;")
      .replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;")
      .replaceAll("'", "&#039;");
  }

  function mutatePhrase(base, intensity){
    if (intensity <= 0) return { text: base, score: 0 };

    let s = base;
    let edits = 0;

    if (chance(intensity * 0.45)) {
      const parts = s.split(/\s+/).filter(Boolean);
      if (parts.length > 2) {
        const i = Math.floor(Math.random() * parts.length);
        parts.splice(i, 0, parts[i]);
        s = parts.join(" ");
        edits += 2;
      }
    }

    if (chance(intensity * 0.25)) {
      const parts = s.split(/\s+/).filter(Boolean);
      const candidates = parts
        .map((w, i) => ({ w, i }))
        .filter(x => x.w.length <= 4 && x.i > 0 && x.i < parts.length - 1);
      if (candidates.length) {
        const pick = candidates[Math.floor(Math.random() * candidates.length)];
        parts.splice(pick.i, 1);
        s = parts.join(" ");
        edits += 2;
      }
    }

    if (chance(intensity * 0.35)) {
      const before = s;
      s = s.replace(/[''"]/g, "");
      if (s !== before) edits += 1;
    }

    if (chance(intensity * 0.45) && s.length > 6) {
      const idx = 1 + Math.floor(Math.random() * (s.length - 3));
      const a = s[idx], b = s[idx + 1];
      if (a && b && a !== " " && b !== " ") {
        s = s.slice(0, idx) + b + a + s.slice(idx + 2);
        edits += 1;
      }
    }

    if (chance(intensity * 0.18)) {
      const cut = Math.min(s.length, 16 + Math.floor(Math.random() * 10));
      const frag = s.slice(0, cut).trim();
      if (frag.length > 6) {
        s = `${frag} / ${s}`;
        edits += 2;
      }
    }

    const denom = Math.max(12, base.length);
    const score = clamp(edits / denom, 0, 1);
    return { text: s, score };
  }

  function buildStreamHTML(lines){
    let html = "";
    let localScore = 0;

    for (let i = 0; i < lines; i++){
      const m = mutatePhrase(state.phrase, state.glitch);
      localScore += m.score;
      html += `<span class="line">${escapeHtml(m.text)}</span>`;
    }

    const avg = localScore / Math.max(1, lines);
    return { html, score: avg };
  }

  function clearStreams(){
    while (rain.firstChild) rain.removeChild(rain.firstChild);
  }

  function updateHallucMeter(streamScore){
    halluc = (halluc * 0.86) + (streamScore * 0.14);
    const pct = Math.round(halluc * 100);
    hallucFill.style.width = `${pct}%`;
    hallucPct.textContent = `${pct}%`;
    hallucBar.setAttribute("aria-valuenow", String(pct));
  }

  function createStream(){
    const stream = document.createElement("div");
    stream.className = "stream";
    if (state.wrap === "on") stream.classList.add("wrap");
    stream.setAttribute("aria-hidden", "true");

    const w = rain.clientWidth || window.innerWidth;
    const left = Math.random() * Math.max(0, w - 60);

    const baseDur = computeDuration(state.speed);
    const dur = baseDur * (0.70 + Math.random() * 0.85);
    const delay = -(Math.random() * dur);

    const sizeJitter = state.size * (0.90 + Math.random() * 0.25);
    const opJitter = clamp(state.opacity * (0.55 + Math.random() * 0.70), 0.12, 1);

    const lines = 18 + Math.floor(Math.random() * 18);
    const sway = Math.max(0, state.drift) * (0.35 + Math.random() * 0.85);

    stream.style.left = `${left}px`;
    stream.style.animationDuration = `${dur}s, ${Math.max(6, dur * 0.65)}s`;
    stream.style.animationDelay = `${delay}s, ${delay}s`;
    stream.style.setProperty("--size", `${sizeJitter}px`);
    stream.style.setProperty("--opacity", String(opJitter));
    stream.style.setProperty("--sway", String(sway));

    const built = buildStreamHTML(lines);
    stream.innerHTML = built.html;
    rain.appendChild(stream);

    updateHallucMeter(built.score);
  }

  function rebuildStreams(){
    clearStreams();
    const frag = document.createDocumentFragment();
    const n = clamp(state.density, 1, 100);

    for (let i = 0; i < n; i++){
      const holder = document.createElement("div");
      holder.className = "stream";
      if (state.wrap === "on") holder.classList.add("wrap");
      holder.setAttribute("aria-hidden", "true");

      const w = rain.clientWidth || window.innerWidth;
      const left = Math.random() * Math.max(0, w - 60);

      const baseDur = computeDuration(state.speed);
      const dur = baseDur * (0.70 + Math.random() * 0.85);
      const delay = -(Math.random() * dur);

      const sizeJitter = state.size * (0.90 + Math.random() * 0.25);
      const opJitter = clamp(state.opacity * (0.55 + Math.random() * 0.70), 0.12, 1);
      const lines = 18 + Math.floor(Math.random() * 18);
      const sway = Math.max(0, state.drift) * (0.35 + Math.random() * 0.85);

      holder.style.left = `${left}px`;
      holder.style.animationDuration = `${dur}s, ${Math.max(6, dur * 0.65)}s`;
      holder.style.animationDelay = `${delay}s, ${delay}s`;
      holder.style.setProperty("--size", `${sizeJitter}px`);
      holder.style.setProperty("--opacity", String(opJitter));
      holder.style.setProperty("--sway", String(sway));

      const built = buildStreamHTML(lines);
      holder.innerHTML = built.html;

      halluc = (halluc * 0.88) + (built.score * 0.12);

      frag.appendChild(holder);
    }

    rain.appendChild(frag);

    const pct = Math.round(clamp(halluc, 0, 1) * 100);
    hallucFill.style.width = `${pct}%`;
    hallucPct.textContent = `${pct}%`;
    hallucBar.setAttribute("aria-valuenow", String(pct));

    statsText.textContent = `${n} streams`;
    updateReaderText();
  }

  function updateReaderText(){
    const lines = 70;
    let out = "";
    let local = 0;

    for (let i = 0; i < lines; i++){
      const m = mutatePhrase(state.phrase, state.glitch);
      out += m.text + "\n";
      local += m.score;
    }

    readerText.textContent = out.trimEnd();
    const avg = local / Math.max(1, lines);
    updateHallucMeter(avg);
  }

  function applyVars(){
    setRootVar("--size", `${state.size}px`);
    setRootVar("--opacity", String(state.opacity));
    setRootVar("--blur", `${state.blur}px`);
  }

  function setPaused(next){
    state.paused = next;
    rain.classList.toggle("paused", state.paused);
    togglePauseBtn.textContent = state.paused ? "Resume" : "Pause";
    statusPill.textContent = state.paused ? "Paused" : "Running";
    announce(state.paused ? "Paused." : "Resumed.");
  }

  function setReaderMode(next){
    state.readerMode = next;
    reader.hidden = !state.readerMode;
    readerBtn.setAttribute("aria-pressed", String(state.readerMode));
    readerBtn.textContent = state.readerMode ? "Exit reader mode" : "Reader mode";
    if (state.readerMode) setPaused(true);
    updateReaderText();
  }

  async function copyReaderText(){
    try{
      await navigator.clipboard.writeText(readerText.textContent || "");
      announce("Copied reader text.");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = readerText.textContent || "";
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      document.body.removeChild(ta);
      announce("Copied reader text.");
    }
  }

  function burstAt(x, y){
    const stream = document.createElement("div");
    stream.className = "stream";
    if (state.wrap === "on") stream.classList.add("wrap");
    stream.setAttribute("aria-hidden", "true");

    const dur = computeDuration(state.speed) * 0.55;
    const sway = Math.max(0, state.drift) * 0.9;

    stream.style.left = `${x}px`;
    stream.style.top = `${y - 140}px`;
    stream.style.animationDuration = `${dur}s, ${Math.max(5, dur * 0.6)}s`;
    stream.style.animationDelay = `0s, 0s`;
    stream.style.setProperty("--size", `${state.size * 1.05}px`);
    stream.style.setProperty("--opacity", String(clamp(state.opacity * 1.15, 0.12, 1)));
    stream.style.setProperty("--sway", String(sway));

    const built = buildStreamHTML(24);
    stream.innerHTML = built.html;
    rain.appendChild(stream);
    updateHallucMeter(built.score);

    window.setTimeout(() => {
      if (stream && stream.parentNode) stream.parentNode.removeChild(stream);
    }, Math.ceil(dur * 1000));
  }

  function readStateFromUI(){
    state.phrase = (phraseEl.value || "").trim() || "Schools don't just happen to exist";
    state.speed = Number(speedEl.value);
    state.density = Number(densityEl.value);
    state.size = Number(sizeEl.value);
    state.opacity = Number(opacityEl.value);
    state.glitch = Number(glitchEl.value);
    state.drift = Number(driftEl.value);
    state.blur = Number(blurEl.value);
    state.wrap = wrapEl.value;
  }

  function onUIInput(e){
    readStateFromUI();
    updateOutputs();
    applyVars();

    const id = e.target && e.target.id;

    if (id === "invert"){
      document.body.classList.toggle("invert", invertEl.checked);
      return;
    }

    if (id === "speed"){
      document.querySelectorAll(".stream").forEach((el) => {
        const baseDur = computeDuration(state.speed);
        const dur = baseDur * (0.70 + Math.random() * 0.85);
        const delay = -(Math.random() * dur);
        el.style.animationDuration = `${dur}s, ${Math.max(6, dur * 0.65)}s`;
        el.style.animationDelay = `${delay}s, ${delay}s`;
      });
      return;
    }

    if (id === "size" || id === "opacity" || id === "blur"){
      updateReaderText();
      return;
    }

    if (id === "density" || id === "phrase" || id === "glitch" || id === "drift" || id === "wrap"){
      rebuildStreams();
      return;
    }
  }

  ui.addEventListener("input", onUIInput);

  togglePauseBtn.addEventListener("click", () => setPaused(!state.paused));
  regenBtn.addEventListener("click", () => rebuildStreams());

  resetBtn.addEventListener("click", () => {
    phraseEl.value = "Schools don't just happen to exist";
    speedEl.value = "10";
    densityEl.value = "28";
    sizeEl.value = "18";
    opacityEl.value = "0.6";
    glitchEl.value = "0.2";
    driftEl.value = "10";
    blurEl.value = "0.6";
    wrapEl.value = "off";
    invertEl.checked = false;
    document.body.classList.remove("invert");

    halluc = 0;
    readStateFromUI();
    updateOutputs();
    applyVars();
    rebuildStreams();
    setReaderMode(false);
    setPaused(prefersReducedMotion);
    announce("Reset.");
  });

  readerBtn.addEventListener("click", () => setReaderMode(!state.readerMode));
  copyReaderBtn.addEventListener("click", copyReaderText);

  rain.addEventListener("click", (ev) => {
    const rect = rain.getBoundingClientRect();
    burstAt(ev.clientX - rect.left, ev.clientY - rect.top);
  });

  rain.addEventListener("keydown", (ev) => {
    if (ev.code === "Space"){
      ev.preventDefault();
      setPaused(!state.paused);
    }
    if (ev.key === "c" || ev.key === "C"){
      ev.preventDefault();
      if (!state.readerMode) setReaderMode(true);
      copyReaderText();
    }
    if (ev.key === "r" || ev.key === "R"){
      ev.preventDefault();
      rebuildStreams();
      announce("Regenerated.");
    }
  });

  let resizeT = null;
  window.addEventListener("resize", () => {
    window.clearTimeout(resizeT);
    resizeT = window.setTimeout(() => rebuildStreams(), 140);
  });

  function init(){
    readStateFromUI();
    updateOutputs();
    applyVars();
    rebuildStreams();
    setPaused(prefersReducedMotion);
  }

  init();
})();
  </script>
</body>
</html>
