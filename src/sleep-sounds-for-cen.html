<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep Sounds for Cen - Bot Sportello</title>
    <link rel="stylesheet" href="../page-theme.css">
    <style>
        body {
            padding: 80px 20px 20px 20px;
            background: #0a0a0a;
            overflow-x: hidden;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #00ffff;
            font-size: 2em;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .header p {
            color: #7ec8e3;
            font-size: 0.9em;
        }

        .breathing-guide {
            width: 100%;
            max-width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .night-sky {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(ellipse at center, #1a1a2e 0%, #0a0a0a 70%);
            border-radius: 50%;
            overflow: hidden;
        }

        .star {
            position: absolute;
            width: 2px;
            height: 2px;
            background: #7ec8e3;
            border-radius: 50%;
            animation: twinkle 3s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .breathing-circle {
            position: relative;
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(126, 200, 227, 0.3), rgba(0, 255, 255, 0.1));
            border: 2px solid #00ffff;
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.3);
            animation: breathe 8s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes breathe {
            0%, 100% { transform: scale(0.7); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
        }

        .breathing-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffff;
            font-size: 0.9em;
            z-index: 20;
            text-align: center;
            animation: breatheText 8s ease-in-out infinite;
        }

        @keyframes breatheText {
            0%, 45% { opacity: 1; content: 'Breathe In'; }
            50%, 95% { opacity: 1; content: 'Breathe Out'; }
            46%, 49%, 96%, 99% { opacity: 0; }
        }

        .controls-section {
            background: rgba(126, 200, 227, 0.05);
            border: 1px solid #7ec8e3;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .controls-section h2 {
            color: #00ffff;
            font-size: 1.2em;
            margin-bottom: 15px;
            text-align: center;
        }

        .sound-control {
            margin-bottom: 20px;
        }

        .sound-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .sound-label {
            color: #7ec8e3;
            font-size: 0.9em;
        }

        .sound-toggle {
            background: transparent;
            border: 2px solid #7ec8e3;
            color: #7ec8e3;
            padding: 4px 12px;
            border-radius: 4px;
            font-family: 'Courier Prime', monospace;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 60px;
        }

        .sound-toggle.active {
            background: #00ffff;
            color: #0a0a0a;
            border-color: #00ffff;
        }

        .volume-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(126, 200, 227, 0.2);
            outline: none;
            -webkit-appearance: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .volume-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #00ffff;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .timer-controls {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .timer-btn {
            background: transparent;
            border: 2px solid #7ec8e3;
            color: #7ec8e3;
            padding: 12px 8px;
            border-radius: 4px;
            font-family: 'Courier Prime', monospace;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .timer-btn.active {
            background: #ff0000;
            color: #fff;
            border-color: #ff0000;
        }

        .timer-display {
            text-align: center;
            color: #00ffff;
            font-size: 1.5em;
            margin-top: 10px;
            min-height: 40px;
        }

        .master-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .master-btn {
            flex: 1;
            background: #ff0000;
            border: 2px solid #ff0000;
            color: #fff;
            padding: 14px;
            border-radius: 4px;
            font-family: 'Courier Prime', monospace;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 48px;
        }

        .master-btn:active {
            transform: scale(0.98);
        }

        .master-btn.playing {
            background: transparent;
            color: #ff0000;
        }

        .status-bar {
            text-align: center;
            color: #7ec8e3;
            font-size: 0.85em;
            margin-top: 15px;
            min-height: 20px;
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.5em;
            }

            .breathing-guide {
                max-width: 250px;
                height: 250px;
            }

            .breathing-circle {
                width: 120px;
                height: 120px;
            }

            .timer-controls {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls-section {
                padding: 15px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 80px 15px 15px 15px;
            }
        }
    </style>
</head>
<body>
    <a href="../index.html" class="home-link" aria-label="Back to home"></a>

    <div class="container">
        <div class="header">
            <h1>Sleep Sounds for Cen</h1>
            <p>Ambient sound mixer for peaceful rest</p>
        </div>

        <div class="breathing-guide">
            <div class="night-sky" id="nightSky"></div>
            <div class="breathing-circle"></div>
            <div class="breathing-text" id="breathingText">Breathe In</div>
        </div>

        <div class="controls-section">
            <h2>Sound Layers</h2>
            
            <div class="sound-control">
                <div class="sound-header">
                    <span class="sound-label">Rain</span>
                    <button class="sound-toggle" data-sound="rain">OFF</button>
                </div>
                <input type="range" class="volume-slider" data-sound="rain" min="0" max="100" value="70">
            </div>

            <div class="sound-control">
                <div class="sound-header">
                    <span class="sound-label">Ocean Waves</span>
                    <button class="sound-toggle" data-sound="ocean">OFF</button>
                </div>
                <input type="range" class="volume-slider" data-sound="ocean" min="0" max="100" value="60">
            </div>

            <div class="sound-control">
                <div class="sound-header">
                    <span class="sound-label">Heartbeat</span>
                    <button class="sound-toggle" data-sound="heartbeat">OFF</button>
                </div>
                <input type="range" class="volume-slider" data-sound="heartbeat" min="0" max="100" value="50">
            </div>

            <div class="sound-control">
                <div class="sound-header">
                    <span class="sound-label">White Noise</span>
                    <button class="sound-toggle" data-sound="whitenoise">OFF</button>
                </div>
                <input type="range" class="volume-slider" data-sound="whitenoise" min="0" max="100" value="40">
            </div>

            <div class="sound-control">
                <div class="sound-header">
                    <span class="sound-label">Lullaby</span>
                    <button class="sound-toggle" data-sound="lullaby">OFF</button>
                </div>
                <input type="range" class="volume-slider" data-sound="lullaby" min="0" max="100" value="30">
            </div>
        </div>

        <div class="controls-section">
            <h2>Sleep Timer</h2>
            <div class="timer-controls">
                <button class="timer-btn" data-minutes="15">15 min</button>
                <button class="timer-btn" data-minutes="30">30 min</button>
                <button class="timer-btn" data-minutes="60">60 min</button>
                <button class="timer-btn" data-minutes="0">Off</button>
            </div>
            <div class="timer-display" id="timerDisplay"></div>
        </div>

        <div class="master-controls">
            <button class="master-btn" id="playBtn">Start Sounds</button>
        </div>

        <div class="status-bar" id="statusBar">Configure your sounds and press Start</div>
    </div>

    <script>
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const sounds = {};
        let timerInterval = null;
        let timerEndTime = null;
        let fadeInterval = null;
        let isPlaying = false;
        let breathingInterval = null;

        const soundConfigs = {
            rain: { freq: 200, type: 'noise', filter: 'lowpass' },
            ocean: { freq: 100, type: 'noise', filter: 'bandpass' },
            heartbeat: { freq: 1.2, type: 'pulse' },
            whitenoise: { freq: 0, type: 'noise', filter: 'none' },
            lullaby: { freq: 440, type: 'melody' }
        };

        function createNoiseBuffer() {
            const bufferSize = audioContext.sampleRate * 2;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const output = buffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            return buffer;
        }

        function initSound(name, config) {
            const gainNode = audioContext.createGain();
            gainNode.gain.value = 0;
            gainNode.connect(audioContext.destination);

            let source, filter;

            if (config.type === 'noise') {
                source = audioContext.createBufferSource();
                source.buffer = createNoiseBuffer();
                source.loop = true;

                if (config.filter !== 'none') {
                    filter = audioContext.createBiquadFilter();
                    filter.type = config.filter;
                    filter.frequency.value = config.freq;
                    filter.Q.value = 1;
                    source.connect(filter);
                    filter.connect(gainNode);
                } else {
                    source.connect(gainNode);
                }

                source.start(0);
            } else if (config.type === 'pulse') {
                const osc = audioContext.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = 60;
                
                const pulseGain = audioContext.createGain();
                pulseGain.gain.value = 0;
                
                osc.connect(pulseGain);
                pulseGain.connect(gainNode);
                osc.start(0);

                source = osc;
                
                setInterval(() => {
                    if (sounds[name] && sounds[name].active) {
                        const now = audioContext.currentTime;
                        pulseGain.gain.cancelScheduledValues(now);
                        pulseGain.gain.setValueAtTime(0, now);
                        pulseGain.gain.linearRampToValueAtTime(1, now + 0.1);
                        pulseGain.gain.linearRampToValueAtTime(0, now + 0.3);
                    }
                }, 833);
            } else if (config.type === 'melody') {
                const notes = [523.25, 493.88, 440, 392, 440, 493.88];
                let noteIndex = 0;
                
                const osc = audioContext.createOscillator();
                osc.type = 'sine';
                osc.frequency.value = notes[0];
                osc.connect(gainNode);
                osc.start(0);

                source = osc;

                setInterval(() => {
                    if (sounds[name] && sounds[name].active) {
                        noteIndex = (noteIndex + 1) % notes.length;
                        const now = audioContext.currentTime;
                        osc.frequency.setTargetAtTime(notes[noteIndex], now, 0.3);
                    }
                }, 2000);
            }

            sounds[name] = {
                gainNode,
                source,
                filter,
                active: false,
                volume: 0.7
            };
        }

        Object.entries(soundConfigs).forEach(([name, config]) => {
            initSound(name, config);
        });

        function createStars() {
            const nightSky = document.getElementById('nightSky');
            for (let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                nightSky.appendChild(star);
            }
        }

        createStars();

        function updateBreathingText() {
            const text = document.getElementById('breathingText');
            let phase = 0;
            
            breathingInterval = setInterval(() => {
                if (phase === 0) {
                    text.textContent = 'Breathe In';
                    phase = 1;
                } else {
                    text.textContent = 'Breathe Out';
                    phase = 0;
                }
            }, 4000);
        }

        updateBreathingText();

        document.querySelectorAll('.sound-toggle').forEach(btn => {
            btn.addEventListener('click', function() {
                const soundName = this.dataset.sound;
                const sound = sounds[soundName];
                
                sound.active = !sound.active;
                this.textContent = sound.active ? 'ON' : 'OFF';
                this.classList.toggle('active');

                if (isPlaying) {
                    const targetVolume = sound.active ? sound.volume : 0;
                    sound.gainNode.gain.linearRampToValueAtTime(
                        targetVolume,
                        audioContext.currentTime + 0.5
                    );
                }

                saveSettings();
                updateStatus();
            });
        });

        document.querySelectorAll('.volume-slider').forEach(slider => {
            slider.addEventListener('input', function() {
                const soundName = this.dataset.sound;
                const sound = sounds[soundName];
                sound.volume = this.value / 100;

                if (isPlaying && sound.active) {
                    sound.gainNode.gain.linearRampToValueAtTime(
                        sound.volume,
                        audioContext.currentTime + 0.1
                    );
                }

                saveSettings();
            });

            slider.addEventListener('touchstart', function(e) {
                e.preventDefault();
            }, { passive: false });
        });

        document.querySelectorAll('.timer-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.timer-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');

                const minutes = parseInt(this.dataset.minutes);
                
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }

                if (minutes > 0 && isPlaying) {
                    timerEndTime = Date.now() + (minutes * 60 * 1000);
                    startTimer();
                } else {
                    timerEndTime = null;
                    document.getElementById('timerDisplay').textContent = '';
                }

                saveSettings();
            });
        });

        function startTimer() {
            updateTimerDisplay();
            timerInterval = setInterval(() => {
                updateTimerDisplay();
                
                const remaining = timerEndTime - Date.now();
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    fadeOutAndStop();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            if (!timerEndTime) return;
            
            const remaining = Math.max(0, timerEndTime - Date.now());
            const minutes = Math.floor(remaining / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function fadeOutAndStop() {
            const fadeSteps = 30;
            let step = 0;

            fadeInterval = setInterval(() => {
                step++;
                const factor = 1 - (step / fadeSteps);

                Object.values(sounds).forEach(sound => {
                    if (sound.active) {
                        sound.gainNode.gain.value = sound.volume * factor;
                    }
                });

                if (step >= fadeSteps) {
                    clearInterval(fadeInterval);
                    stopAllSounds();
                }
            }, 1000);

            document.getElementById('statusBar').textContent = 'Fading out...';
        }

        document.getElementById('playBtn').addEventListener('click', function() {
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            if (!isPlaying) {
                startAllSounds();
                this.textContent = 'Stop Sounds';
                this.classList.add('playing');
                isPlaying = true;

                const activeTimer = document.querySelector('.timer-btn.active');
                if (activeTimer) {
                    const minutes = parseInt(activeTimer.dataset.minutes);
                    if (minutes > 0) {
                        timerEndTime = Date.now() + (minutes * 60 * 1000);
                        startTimer();
                    }
                }
            } else {
                stopAllSounds();
                this.textContent = 'Start Sounds';
                this.classList.remove('playing');
                isPlaying = false;

                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                document.getElementById('timerDisplay').textContent = '';
            }
        });

        function startAllSounds() {
            Object.entries(sounds).forEach(([name, sound]) => {
                if (sound.active) {
                    sound.gainNode.gain.linearRampToValueAtTime(
                        sound.volume,
                        audioContext.currentTime + 2
                    );
                }
            });
            updateStatus();
        }

        function stopAllSounds() {
            Object.values(sounds).forEach(sound => {
                sound.gainNode.gain.linearRampToValueAtTime(
                    0,
                    audioContext.currentTime + 1
                );
            });
            document.getElementById('statusBar').textContent = 'Sounds stopped';
        }

        function updateStatus() {
            const activeSounds = Object.entries(sounds)
                .filter(([_, sound]) => sound.active)
                .map(([name, _]) => name);

            if (activeSounds.length === 0) {
                document.getElementById('statusBar').textContent = 'No sounds selected';
            } else if (isPlaying) {
                document.getElementById('statusBar').textContent = 
                    `Playing: ${activeSounds.join(', ')}`;
            } else {
                document.getElementById('statusBar').textContent = 
                    `Ready: ${activeSounds.join(', ')}`;
            }
        }

        function saveSettings() {
            const settings = {
                sounds: {},
                timer: document.querySelector('.timer-btn.active')?.dataset.minutes || '0'
            };

            Object.entries(sounds).forEach(([name, sound]) => {
                settings.sounds[name] = {
                    active: sound.active,
                    volume: sound.volume
                };
            });

            localStorage.setItem('sleepSoundsSettings', JSON.stringify(settings));
        }

        function loadSettings() {
            const saved = localStorage.getItem('sleepSoundsSettings');
            if (!saved) return;

            try {
                const settings = JSON.parse(saved);

                Object.entries(settings.sounds).forEach(([name, config]) => {
                    if (sounds[name]) {
                        sounds[name].active = config.active;
                        sounds[name].volume = config.volume;

                        const toggle = document.querySelector(`.sound-toggle[data-sound="${name}"]`);
                        const slider = document.querySelector(`.volume-slider[data-sound="${name}"]`);

                        if (toggle) {
                            toggle.textContent = config.active ? 'ON' : 'OFF';
                            toggle.classList.toggle('active', config.active);
                        }

                        if (slider) {
                            slider.value = config.volume * 100;
                        }
                    }
                });

                if (settings.timer) {
                    const timerBtn = document.querySelector(`.timer-btn[data-minutes="${settings.timer}"]`);
                    if (timerBtn) {
                        timerBtn.classList.add('active');
                    }
                }

                updateStatus();
            } catch (e) {
                console.error('Failed to load settings:', e);
            }
        }

        loadSettings();
        updateStatus();
    </script>
</body>
</html>