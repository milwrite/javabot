<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peanut City - Bot Sportello Noir</title>
    <link rel="stylesheet" href="../page-theme.css">
</head>
<body class="story-page">
    <a href="../index.html" class="home-link">←</a>

    <div class="progress-indicator">
        <div class="progress-bar" id="progressBar"></div>
    </div>

    <div class="story-container">
        <header class="story-header">
            <h1 class="story-title">PEANUT CITY</h1>
            <p class="story-subtitle">A Tale of Shells and Secrets</p>
        </header>

        <div class="chapter" data-chapter="1">
            <div class="chapter-number">Chapter One</div>
            <h2 class="chapter-title">The Arrival</h2>
            <p class="paragraph">
                They called it <span class="emphasis">Peanut City</span>, though nobody remembered why. The sign at the edge of town had long since faded, its letters peeling like sunburned skin. I rolled in on a Tuesday, the kind of Tuesday that tastes like dust and regret.
            </p>
            <p class="paragraph">
                The streets were lined with shells. Not metaphorical shells—actual peanut shells, ankle-deep in some places, crunching under every footstep like tiny bones. The locals didn't seem to notice. They walked through them like snow, their faces blank as fresh paper.
            </p>
            <p class="paragraph whisper">
                "You're not from around here," the gas station attendant said. It wasn't a question.
            </p>
            <p class="paragraph">
                I paid for my coffee with exact change and asked about lodging. He pointed down Main Street with a finger stained the color of roasted nuts. "The Legume Hotel. Only place in town. Tell Martha that Earl sent you."
            </p>
        </div>


        <div class="chapter" data-chapter="2">
            <div class="chapter-number">Chapter Two</div>
            <h2 class="chapter-title">The Legume Hotel</h2>
            <p class="paragraph">
                Martha was exactly what you'd expect: seventy years of hard living wrapped in a floral housedress. She took my money without counting it and handed me a key attached to a wooden peanut.
            </p>
            <p class="paragraph">
                "Room 237," she said. "Don't mind the smell."
            </p>
            <p class="paragraph">
                The smell was <span class="emphasis">peanut butter</span>. Everything smelled like peanut butter. The wallpaper, the bedsheets, the air itself—all of it thick with that cloying, nutty sweetness. I opened the window but the breeze that came in only brought more of it.
            </p>
            <p class="paragraph">
                That's when I noticed the factory. Massive and dark against the evening sky, its smokestacks pumping out clouds that looked too thick to be steam. The <span class="emphasis">Peanut City Processing Plant</span>, according to the faded letters on its side.
            </p>
            <p class="paragraph whisper">
                Everyone in this town works there, I thought. Everyone.
            </p>
        </div>


        <div class="chapter" data-chapter="3">
            <div class="chapter-number">Chapter Three</div>
            <h2 class="chapter-title">The Night Shift</h2>
            <p class="paragraph">
                Sleep didn't come easy. Around midnight, I heard them—the workers, marching in perfect unison down Main Street. Their footsteps synchronized, crushing shells in rhythmic waves. I watched from my window as they filed into the factory, hundreds of them, all wearing the same blank expression.
            </p>
            <p class="paragraph">
                One of them looked up. Our eyes met. For a moment, I thought I saw recognition, maybe even fear. Then her face smoothed over like water, and she disappeared inside with the others.
            </p>
            <p class="paragraph">
                I had to know. I pulled on my coat and followed.
            </p>
        </div>


        <div class="chapter" data-chapter="4">
            <div class="chapter-number">Chapter Four</div>
            <h2 class="chapter-title">Inside the Shell</h2>
            <p class="paragraph">
                The factory doors were unlocked. Inside, the machinery hummed with a sound that was almost musical—a low, droning note that vibrated in my chest. The workers stood at their stations, moving with mechanical precision, sorting, shelling, processing.
            </p>
            <p class="paragraph">
                But they weren't processing peanuts.
            </p>
            <p class="paragraph">
                They were processing <span class="emphasis">themselves</span>.
            </p>
            <p class="paragraph">
                I watched in horror as one worker stepped onto a conveyor belt. The machinery whirred to life, and she began to... compact. Fold. Compress. Until she was the size and shape of a peanut shell. The belt carried her to a bin where thousands of others lay, identical and hollow.
            </p>
            <p class="paragraph whisper">
                The streets, I realized. The shells in the streets. They weren't peanuts at all.
            </p>
        </div>


        <div class="chapter" data-chapter="5">
            <div class="chapter-number">Chapter Five</div>
            <h2 class="chapter-title">The Truth</h2>
            <p class="paragraph">
                I ran. Through corridors that smelled of oil and salt, past rooms filled with bins of shells, each one a person who'd walked into this town and never left. The factory was a labyrinth, but I found the center—a control room with walls covered in monitors.
            </p>
            <p class="paragraph">
                On the screens: other towns. Dozens of them. All identical. All called <span class="emphasis">Peanut City</span>. All with their own factories, their own workers, their own streets of shells.
            </p>
            <p class="paragraph">
                And in the center of the room, a figure sat at a console. When it turned, I saw its face—or rather, the absence of one. Just smooth, polished wood carved into the shape of a peanut.
            </p>
            <p class="paragraph whisper">
                "Welcome," it said, its voice like rustling paper. "We've been expecting you."
            </p>
        </div>

        <div class="twist-reveal">
            <p class="reveal-text">
                THERE IS NO ESCAPE FROM PEANUT CITY.<br>
                THERE NEVER WAS.<br>
                YOU WERE ALWAYS PART OF THE PROCESS.
            </p>
        </div>

        <div class="chapter" data-chapter="6">
            <div class="chapter-number">Epilogue</div>
            <h2 class="chapter-title">The Shell Game</h2>
            <div class="epilogue">
                    <p class="paragraph">
                        I write this from Room 237 of The Legume Hotel. My hands are steady. My mind is clear. Tomorrow, I'll join the night shift at the factory. I'll take my place on the line with the others.
                    </p>
                    <p class="paragraph">
                        The peanut-faced thing explained it all. <span class="emphasis">Peanut City</span> isn't a place—it's a process. A transformation. We arrive as individuals, complex and messy, and we leave as something simpler. Cleaner. More efficient.
                    </p>
                    <p class="paragraph">
                        The shells in the streets? They're not discarded husks. They're <span class="emphasis">seeds</span>. Each one will blow to a new town, take root, and grow into another Peanut City. The cycle continues. The harvest never ends.
                    </p>
                    <p class="paragraph whisper">
                        And you know what the funny thing is?
                    </p>
                    <p class="paragraph">
                        I don't mind anymore. The smell of peanut butter doesn't bother me. The blank faces make sense now. We're all just nuts in the end, waiting to be cracked open and consumed by something larger than ourselves.
                    </p>
                    <p class="paragraph">
                        If you're reading this, you've probably already arrived. You've probably already checked into your room. You've probably already noticed the smell.
                    </p>
                    <p class="paragraph story-final">
                        Welcome to Peanut City.
                    </p>
                    <p class="paragraph story-final-sub">
                        Population: You.
                    </p>
                    <div class="signature">
                        — A Former Traveler<br>
                        Now and Forever a Resident
                    </div>
            </div>
        </div>

        <div class="story-ending">
            THE END<br>
            <span class="story-ending-sub">(OR IS IT THE BEGINNING?)</span>
        </div>
    </div>

    <!-- Audio Controls - Bot Sportello Narrator -->
    <div class="audio-controls" id="audioControls">
        <h4>Narration</h4>
        <div class="narrator-name">Bot Sportello</div>
        <div>
            <button class="audio-btn play" id="playBtn" onclick="toggleNarration()">Play</button>
            <button class="audio-btn stop" onclick="stopNarration()">Stop</button>
        </div>
        <select class="voice-select" id="voiceSelect" onchange="changeVoice()">
            <option value="">Loading voices...</option>
        </select>
        <div class="audio-status" id="audioStatus">Ready to play</div>
    </div>

    <script>
        // Scroll-triggered reveal animations
        const chapters = document.querySelectorAll('.chapter');
        const progressBar = document.getElementById('progressBar');

        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top <= (window.innerHeight || document.documentElement.clientHeight) * 0.75
            );
        }

        function checkChapters() {
            chapters.forEach(chapter => {
                if (isElementInViewport(chapter) && !chapter.classList.contains('revealed')) {
                    chapter.classList.add('revealed');
                }
            });
        }

        // Progress indicator
        function updateProgress() {
            const windowHeight = window.innerHeight;
            const documentHeight = document.documentElement.scrollHeight - windowHeight;
            const scrolled = window.pageYOffset;
            const progress = (scrolled / documentHeight) * 100;
            progressBar.style.height = `${Math.min(progress, 100)}%`;
        }

        // Scroll event listeners
        let ticking = false;

        function onScroll() {
            if (!ticking) {
                window.requestAnimationFrame(() => {
                    checkChapters();
                    updateProgress();
                    ticking = false;
                });
                ticking = true;
            }
        }

        window.addEventListener('scroll', onScroll, { passive: true });
        window.addEventListener('resize', checkChapters, { passive: true });

        // Initial check
        checkChapters();
        updateProgress();

        // Typewriter effect for title
        const title = document.querySelector('h1');
        if (title && window.innerWidth > 768) {
            const text = title.textContent;
            title.textContent = '';
            let i = 0;

            function typeWriter() {
                if (i < text.length) {
                    title.textContent += text.charAt(i);
                    i++;
                    setTimeout(typeWriter, 100);
                }
            }

            setTimeout(typeWriter, 500);
        }

        // ========================================
        // Web Speech API TTS - Bot Sportello Voice
        // ========================================
        const synth = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;
        let currentUtterance = null;
        let isPlaying = false;
        let isPaused = false;
        let paragraphs = [];
        let currentParagraphIndex = 0;

        // Preferred voices in order (noir detective style)
        const PREFERRED_VOICES = ['Ralph', 'Daniel', 'Tom', 'Alex', 'Fred'];

        // Get all story text in document order
        function getStoryText() {
            const texts = [];
            const storyContainer = document.querySelector('.story-container');

            // Get all readable elements in order
            const elements = storyContainer.querySelectorAll('.chapter-title, .paragraph, .reveal-text');

            elements.forEach(el => {
                let text = el.textContent.trim();
                if (text) {
                    // Clean up line breaks in reveal text
                    text = text.replace(/\s+/g, ' ');
                    texts.push({ element: el, text: text });
                }
            });

            return texts;
        }

        // Find best available voice
        function findBestVoice(voiceList) {
            if (!voiceList || voiceList.length === 0) return null;

            // Try preferred voices in order
            for (const name of PREFERRED_VOICES) {
                const match = voiceList.find(v =>
                    v.name.includes(name) && v.lang.startsWith('en')
                );
                if (match) return match;
            }

            // Fallback: any English male-sounding voice
            const englishVoices = voiceList.filter(v => v.lang.startsWith('en'));
            if (englishVoices.length > 0) {
                // Prefer voices that sound more "noir" (lower/male names)
                const maleNames = ['David', 'James', 'John', 'Mark', 'Paul'];
                for (const name of maleNames) {
                    const match = englishVoices.find(v => v.name.includes(name));
                    if (match) return match;
                }
                return englishVoices[0];
            }

            // Last resort: any voice
            return voiceList[0];
        }

        // Load and populate voices
        function loadVoices() {
            voices = synth.getVoices();
            const select = document.getElementById('voiceSelect');
            if (!select) return;

            select.innerHTML = '';

            if (voices.length === 0) {
                select.innerHTML = '<option value="">Loading...</option>';
                return;
            }

            // Find best voice
            selectedVoice = findBestVoice(voices);

            // Populate dropdown with English voices
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));
            englishVoices.forEach((voice, idx) => {
                const option = document.createElement('option');
                option.value = idx;
                option.textContent = `${voice.name}`;
                if (voice === selectedVoice) option.selected = true;
                select.appendChild(option);
            });

            const voiceName = selectedVoice ? selectedVoice.name.split(' ')[0] : 'Default';
            document.getElementById('audioStatus').textContent = `Voice: ${voiceName}`;
        }

        // Initialize voices
        if (synth.onvoiceschanged !== undefined) {
            synth.onvoiceschanged = loadVoices;
        }
        // Try loading immediately and after a delay (browser quirk)
        loadVoices();
        setTimeout(loadVoices, 100);

        function changeVoice() {
            const select = document.getElementById('voiceSelect');
            const englishVoices = voices.filter(v => v.lang.startsWith('en'));
            const idx = parseInt(select.value);
            if (!isNaN(idx) && englishVoices[idx]) {
                selectedVoice = englishVoices[idx];
                document.getElementById('audioStatus').textContent = `Voice: ${selectedVoice.name.split(' ')[0]}`;
            }
        }

        function getSelectedVoice() {
            return selectedVoice || findBestVoice(voices);
        }

        function highlightParagraph(element) {
            // Remove previous highlights
            document.querySelectorAll('.reading').forEach(el => el.classList.remove('reading'));
            // Add highlight to current
            if (element) {
                element.classList.add('reading');
                element.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        function speakParagraph(index) {
            if (index >= paragraphs.length) {
                stopNarration();
                document.getElementById('audioStatus').textContent = 'Finished';
                return;
            }

            const { element, text } = paragraphs[index];
            highlightParagraph(element);

            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.voice = getSelectedVoice();

            // Detective voice settings - slower, deeper
            currentUtterance.rate = 0.85;   // Slower for noir atmosphere
            currentUtterance.pitch = 0.9;   // Slightly deeper
            currentUtterance.volume = 1;

            currentUtterance.onend = () => {
                if (isPlaying && !isPaused) {
                    currentParagraphIndex++;
                    speakParagraph(currentParagraphIndex);
                }
            };

            currentUtterance.onerror = (e) => {
                console.error('Speech error:', e);
                document.getElementById('audioStatus').textContent = 'Error occurred';
            };

            synth.speak(currentUtterance);
            document.getElementById('audioStatus').textContent = `Reading...`;
        }

        function toggleNarration() {
            const btn = document.getElementById('playBtn');

            if (!isPlaying) {
                // Start playing
                isPlaying = true;
                isPaused = false;
                paragraphs = getStoryText();
                btn.textContent = 'Pause';
                btn.className = 'audio-btn pause';
                speakParagraph(currentParagraphIndex);
            } else if (isPaused) {
                // Resume
                isPaused = false;
                synth.resume();
                btn.textContent = 'Pause';
                btn.className = 'audio-btn pause';
                document.getElementById('audioStatus').textContent = 'Resumed';
            } else {
                // Pause
                isPaused = true;
                synth.pause();
                btn.textContent = 'Resume';
                btn.className = 'audio-btn play';
                document.getElementById('audioStatus').textContent = 'Paused';
            }
        }

        function stopNarration() {
            synth.cancel();
            isPlaying = false;
            isPaused = false;
            currentParagraphIndex = 0;

            const btn = document.getElementById('playBtn');
            btn.textContent = 'Play';
            btn.className = 'audio-btn play';

            document.querySelectorAll('.reading').forEach(el => el.classList.remove('reading'));
            document.getElementById('audioStatus').textContent = 'Ready to play';
        }

        // Check for speech synthesis support
        if (!('speechSynthesis' in window)) {
            document.getElementById('audioControls').innerHTML =
                '<p style="color: #ff0000; font-size: 11px;">Voice narration not supported in this browser.</p>';
        }
    </script>
</body>
</html>
