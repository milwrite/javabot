<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Lightsaber Duel</title>
    <link rel="stylesheet" href="../page-theme.css">
    <style>
        * { box-sizing: border-box; }
        body {
            margin: 0;
            padding: 10px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: #0a0a0a;
            font-family: 'Courier Prime', monospace;
        }
        .game-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }
        h1 {
            color: #00ffff;
            font-size: 1.4em;
            margin: 5px 0;
            text-shadow: 0 0 10px #00ffff;
        }
        .health-bars {
            display: flex;
            justify-content: space-between;
            width: 100%;
            gap: 20px;
            padding: 0 10px;
        }
        .health-container {
            flex: 1;
            text-align: center;
        }
        .health-label {
            color: #7ec8e3;
            font-size: 0.8em;
            margin-bottom: 3px;
        }
        .health-bar {
            height: 20px;
            background: #1a1a1a;
            border: 2px solid #00ffff;
            border-radius: 3px;
            overflow: hidden;
        }
        .health-fill {
            height: 100%;
            transition: width 0.3s;
        }
        .player-health { background: linear-gradient(90deg, #00ff41, #00ffff); }
        .ai-health { background: linear-gradient(90deg, #ff0000, #ff6600); }

        canvas {
            background: linear-gradient(180deg, #0a0a0a 0%, #1a1a2e 50%, #0a0a0a 100%);
            border: 2px solid #00ffff;
            border-radius: 5px;
            max-width: 100%;
            touch-action: none;
        }

        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 500px;
            padding: 5px 10px;
        }
        .d-pad {
            display: grid;
            grid-template-columns: repeat(3, 50px);
            grid-template-rows: repeat(2, 50px);
            gap: 3px;
        }
        .d-btn {
            width: 50px;
            height: 50px;
            background: #1a1a1a;
            border: 2px solid #00ffff;
            border-radius: 8px;
            color: #00ffff;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
        }
        .d-btn:active, .d-btn.active {
            background: #00ffff;
            color: #0a0a0a;
            box-shadow: 0 0 15px #00ffff;
        }
        .d-btn.empty { visibility: hidden; }

        .attack-btn {
            width: 90px;
            height: 90px;
            background: linear-gradient(145deg, #ff0000, #cc0000);
            border: 3px solid #ff0000;
            border-radius: 50%;
            color: #fff;
            font-size: 0.9em;
            font-weight: bold;
            font-family: 'Courier Prime', monospace;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            text-shadow: 0 0 5px #000;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
        }
        .attack-btn:active, .attack-btn.active {
            background: linear-gradient(145deg, #ff3333, #ff0000);
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.8);
            transform: scale(0.95);
        }

        .start-btn {
            padding: 12px 30px;
            font-size: 1em;
            background: transparent;
            border: 2px solid #00ffff;
            color: #00ffff;
            font-family: 'Courier Prime', monospace;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px 0;
        }
        .start-btn:hover {
            background: #00ffff;
            color: #0a0a0a;
        }

        .instructions {
            color: #7ec8e3;
            font-size: 0.75em;
            text-align: center;
            max-width: 400px;
            line-height: 1.4;
        }

        .message {
            color: #00ffff;
            font-size: 1.1em;
            text-align: center;
            min-height: 1.5em;
            text-shadow: 0 0 10px #00ffff;
        }

        .score {
            color: #ff0000;
            font-size: 0.9em;
        }

        @media (max-width: 480px) {
            h1 { font-size: 1.2em; }
            .d-btn { width: 44px; height: 44px; }
            .attack-btn { width: 80px; height: 80px; font-size: 0.8em; }
            .d-pad { grid-template-columns: repeat(3, 44px); grid-template-rows: repeat(2, 44px); }
        }
    </style>
</head>
<body>
    <a class="home-link" href="../index.html"></a>

    <div class="game-container">
        <h1>‚öîÔ∏è LIGHTSABER DUEL ‚öîÔ∏è</h1>

        <div class="health-bars">
            <div class="health-container">
                <div class="health-label">YOU</div>
                <div class="health-bar">
                    <div class="health-fill player-health" id="playerHealth" style="width: 100%"></div>
                </div>
            </div>
            <div class="health-container">
                <div class="health-label">AI</div>
                <div class="health-bar">
                    <div class="health-fill ai-health" id="aiHealth" style="width: 100%"></div>
                </div>
            </div>
        </div>

        <canvas id="arena" width="500" height="300"></canvas>

        <div class="message" id="message">Press START to begin</div>
        <div class="score" id="score">Wins: 0 | Losses: 0</div>

        <div class="controls">
            <div class="d-pad">
                <div class="d-btn empty"></div>
                <div class="d-btn" id="btnUp">‚Üë</div>
                <div class="d-btn empty"></div>
                <div class="d-btn" id="btnLeft">‚Üê</div>
                <div class="d-btn empty"></div>
                <div class="d-btn" id="btnRight">‚Üí</div>
            </div>
            <button class="attack-btn" id="btnAttack">SWING</button>
        </div>

        <button class="start-btn" id="startBtn">START DUEL</button>

        <div class="instructions">
            <strong>Controls:</strong> Arrow keys or D-pad to move<br>
            Space or SWING button to attack<br>
            Time your swings to clash sabers and counter!
        </div>
    </div>

    <script>
        const canvas = document.getElementById('arena');
        const ctx = canvas.getContext('2d');
        const playerHealthBar = document.getElementById('playerHealth');
        const aiHealthBar = document.getElementById('aiHealth');
        const messageEl = document.getElementById('message');
        const scoreEl = document.getElementById('score');
        const startBtn = document.getElementById('startBtn');

        let gameRunning = false;
        let wins = 0, losses = 0;

        const player = {
            x: 100, y: 200, health: 100,
            swinging: false, swingAngle: 0, swingDir: 1,
            blocking: false, hitCooldown: 0,
            stance: 'ready', jumpVel: 0, grounded: true
        };

        const ai = {
            x: 400, y: 200, health: 100,
            swinging: false, swingAngle: 0, swingDir: -1,
            blocking: false, hitCooldown: 0,
            stance: 'ready', jumpVel: 0, grounded: true,
            thinkTimer: 0, action: null
        };

        const GROUND = 240;
        const GRAVITY = 0.8;
        const JUMP_POWER = -15;
        const SABER_LENGTH = 70;
        const SWING_SPEED = 12;

        const keys = { left: false, right: false, up: false, attack: false };

        // Keyboard controls
        document.addEventListener('keydown', e => {
            if (e.code === 'ArrowLeft') keys.left = true;
            if (e.code === 'ArrowRight') keys.right = true;
            if (e.code === 'ArrowUp') keys.up = true;
            if (e.code === 'Space') { keys.attack = true; e.preventDefault(); }
        });
        document.addEventListener('keyup', e => {
            if (e.code === 'ArrowLeft') keys.left = false;
            if (e.code === 'ArrowRight') keys.right = false;
            if (e.code === 'ArrowUp') keys.up = false;
            if (e.code === 'Space') keys.attack = false;
        });

        // Touch controls
        function setupTouchBtn(id, key) {
            const btn = document.getElementById(id);
            const activate = () => { keys[key] = true; btn.classList.add('active'); };
            const deactivate = () => { keys[key] = false; btn.classList.remove('active'); };
            btn.addEventListener('touchstart', e => { e.preventDefault(); activate(); });
            btn.addEventListener('touchend', e => { e.preventDefault(); deactivate(); });
            btn.addEventListener('mousedown', activate);
            btn.addEventListener('mouseup', deactivate);
            btn.addEventListener('mouseleave', deactivate);
        }
        setupTouchBtn('btnUp', 'up');
        setupTouchBtn('btnLeft', 'left');
        setupTouchBtn('btnRight', 'right');
        setupTouchBtn('btnAttack', 'attack');

        startBtn.addEventListener('click', startGame);

        function startGame() {
            player.x = 100; player.y = GROUND; player.health = 100;
            player.swinging = false; player.swingAngle = 0; player.hitCooldown = 0;
            player.jumpVel = 0; player.grounded = true;

            ai.x = 400; ai.y = GROUND; ai.health = 100;
            ai.swinging = false; ai.swingAngle = 0; ai.hitCooldown = 0;
            ai.jumpVel = 0; ai.grounded = true;
            ai.thinkTimer = 0; ai.action = null;

            gameRunning = true;
            messageEl.textContent = 'FIGHT!';
            setTimeout(() => { if (gameRunning) messageEl.textContent = ''; }, 1000);
            gameLoop();
        }

        function updatePlayer() {
            // Movement
            if (keys.left) player.x -= 4;
            if (keys.right) player.x += 4;
            if (keys.up && player.grounded) {
                player.jumpVel = JUMP_POWER;
                player.grounded = false;
            }

            // Jump physics
            if (!player.grounded) {
                player.jumpVel += GRAVITY;
                player.y += player.jumpVel;
                if (player.y >= GROUND) {
                    player.y = GROUND;
                    player.grounded = true;
                    player.jumpVel = 0;
                }
            }

            // Bounds
            player.x = Math.max(30, Math.min(canvas.width - 30, player.x));

            // Swing attack
            if (keys.attack && !player.swinging && player.hitCooldown <= 0) {
                player.swinging = true;
                player.swingAngle = -60;
            }

            if (player.swinging) {
                player.swingAngle += SWING_SPEED;
                if (player.swingAngle >= 60) {
                    player.swinging = false;
                    player.swingAngle = 0;
                    player.hitCooldown = 15;
                }
            }

            if (player.hitCooldown > 0) player.hitCooldown--;
        }

        function updateAI() {
            const dist = Math.abs(ai.x - player.x);

            // AI thinking
            ai.thinkTimer--;
            if (ai.thinkTimer <= 0) {
                ai.thinkTimer = 20 + Math.random() * 30;

                // Decide action based on distance and player state
                if (dist > 120) {
                    ai.action = 'approach';
                } else if (dist < 80 && player.swinging) {
                    ai.action = Math.random() > 0.3 ? 'counter' : 'retreat';
                } else if (dist < 100) {
                    ai.action = Math.random() > 0.4 ? 'attack' : 'dodge';
                } else {
                    ai.action = 'wait';
                }
            }

            // Execute action
            switch(ai.action) {
                case 'approach':
                    ai.x += (player.x < ai.x ? -3 : 3);
                    break;
                case 'retreat':
                    ai.x += (player.x < ai.x ? 4 : -4);
                    break;
                case 'attack':
                    if (!ai.swinging && ai.hitCooldown <= 0 && dist < 110) {
                        ai.swinging = true;
                        ai.swingAngle = -60;
                    }
                    break;
                case 'counter':
                    if (!ai.swinging && ai.hitCooldown <= 0) {
                        ai.swinging = true;
                        ai.swingAngle = -60;
                    }
                    break;
                case 'dodge':
                    if (ai.grounded && Math.random() > 0.7) {
                        ai.jumpVel = JUMP_POWER;
                        ai.grounded = false;
                    }
                    break;
            }

            // Jump physics
            if (!ai.grounded) {
                ai.jumpVel += GRAVITY;
                ai.y += ai.jumpVel;
                if (ai.y >= GROUND) {
                    ai.y = GROUND;
                    ai.grounded = true;
                    ai.jumpVel = 0;
                }
            }

            // Bounds
            ai.x = Math.max(30, Math.min(canvas.width - 30, ai.x));

            // Swing animation
            if (ai.swinging) {
                ai.swingAngle += SWING_SPEED;
                if (ai.swingAngle >= 60) {
                    ai.swinging = false;
                    ai.swingAngle = 0;
                    ai.hitCooldown = 20;
                }
            }

            if (ai.hitCooldown > 0) ai.hitCooldown--;
        }

        function checkCollisions() {
            // Get saber tips
            const playerSaberX = player.x + Math.cos((player.swingAngle - 45) * Math.PI / 180) * SABER_LENGTH;
            const playerSaberY = player.y - 30 + Math.sin((player.swingAngle - 45) * Math.PI / 180) * SABER_LENGTH;

            const aiSaberX = ai.x + Math.cos((180 - ai.swingAngle + 45) * Math.PI / 180) * SABER_LENGTH;
            const aiSaberY = ai.y - 30 + Math.sin((180 - ai.swingAngle + 45) * Math.PI / 180) * SABER_LENGTH;

            // Saber clash
            if (player.swinging && ai.swinging) {
                const saberDist = Math.hypot(playerSaberX - aiSaberX, playerSaberY - aiSaberY);
                if (saberDist < 30) {
                    messageEl.textContent = '‚ö° CLASH! ‚ö°';
                    setTimeout(() => messageEl.textContent = '', 500);
                    player.swinging = false;
                    ai.swinging = false;
                    player.hitCooldown = 25;
                    ai.hitCooldown = 25;
                    // Spark effect
                    drawSparks((playerSaberX + aiSaberX) / 2, (playerSaberY + aiSaberY) / 2);
                }
            }

            // Player hits AI
            if (player.swinging && player.swingAngle > 20 && player.swingAngle < 50) {
                const hitDist = Math.hypot(playerSaberX - ai.x, playerSaberY - (ai.y - 30));
                if (hitDist < 35 && ai.hitCooldown <= 0 && !ai.swinging) {
                    ai.health -= 15;
                    ai.hitCooldown = 30;
                    messageEl.textContent = 'HIT!';
                    setTimeout(() => messageEl.textContent = '', 400);
                }
            }

            // AI hits player
            if (ai.swinging && ai.swingAngle > 20 && ai.swingAngle < 50) {
                const hitDist = Math.hypot(aiSaberX - player.x, aiSaberY - (player.y - 30));
                if (hitDist < 35 && player.hitCooldown <= 0 && !player.swinging) {
                    player.health -= 12;
                    player.hitCooldown = 30;
                    messageEl.textContent = 'OUCH!';
                    setTimeout(() => messageEl.textContent = '', 400);
                }
            }
        }

        let sparks = [];
        function drawSparks(x, y) {
            for (let i = 0; i < 8; i++) {
                sparks.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 15
                });
            }
        }

        function drawFighter(x, y, facing, swingAngle, isPlayer) {
            // Body
            ctx.fillStyle = isPlayer ? '#00ffff' : '#ff0000';
            ctx.fillRect(x - 8, y - 50, 16, 40);

            // Head
            ctx.beginPath();
            ctx.arc(x, y - 60, 12, 0, Math.PI * 2);
            ctx.fill();

            // Legs
            ctx.strokeStyle = ctx.fillStyle;
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(x - 5, y - 10);
            ctx.lineTo(x - 10, y);
            ctx.moveTo(x + 5, y - 10);
            ctx.lineTo(x + 10, y);
            ctx.stroke();

            // Arm holding saber
            const armAngle = (facing === 1 ? swingAngle - 45 : 180 - swingAngle + 45) * Math.PI / 180;
            ctx.beginPath();
            ctx.moveTo(x, y - 40);
            ctx.lineTo(x + Math.cos(armAngle) * 20, y - 40 + Math.sin(armAngle) * 20);
            ctx.stroke();

            // Lightsaber
            const saberStartX = x + Math.cos(armAngle) * 20;
            const saberStartY = y - 40 + Math.sin(armAngle) * 20;
            const saberEndX = x + Math.cos(armAngle) * SABER_LENGTH;
            const saberEndY = y - 40 + Math.sin(armAngle) * SABER_LENGTH;

            // Saber glow
            ctx.shadowColor = isPlayer ? '#00ffff' : '#ff0000';
            ctx.shadowBlur = 15;

            // Saber blade
            ctx.strokeStyle = '#ffffff';
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(saberStartX, saberStartY);
            ctx.lineTo(saberEndX, saberEndY);
            ctx.stroke();

            ctx.strokeStyle = isPlayer ? '#00ffff' : '#ff0000';
            ctx.lineWidth = 6;
            ctx.globalAlpha = 0.5;
            ctx.beginPath();
            ctx.moveTo(saberStartX, saberStartY);
            ctx.lineTo(saberEndX, saberEndY);
            ctx.stroke();
            ctx.globalAlpha = 1;

            ctx.shadowBlur = 0;

            // Hilt
            ctx.fillStyle = '#666';
            ctx.fillRect(x + Math.cos(armAngle) * 15 - 3, y - 40 + Math.sin(armAngle) * 15 - 3, 10, 6);
        }

        function draw() {
            // Clear
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Floor
            ctx.strokeStyle = '#00ffff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, GROUND + 10);
            ctx.lineTo(canvas.width, GROUND + 10);
            ctx.stroke();

            // Grid floor effect
            ctx.strokeStyle = 'rgba(0, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            for (let i = 0; i < canvas.width; i += 40) {
                ctx.beginPath();
                ctx.moveTo(i, GROUND + 10);
                ctx.lineTo(i, canvas.height);
                ctx.stroke();
            }

            // Draw fighters
            drawFighter(player.x, player.y, 1, player.swingAngle, true);
            drawFighter(ai.x, ai.y, -1, ai.swingAngle, false);

            // Draw sparks
            ctx.fillStyle = '#ffff00';
            sparks = sparks.filter(s => {
                s.x += s.vx;
                s.y += s.vy;
                s.life--;
                if (s.life > 0) {
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, 2, 0, Math.PI * 2);
                    ctx.fill();
                    return true;
                }
                return false;
            });

            // Update health bars
            playerHealthBar.style.width = Math.max(0, player.health) + '%';
            aiHealthBar.style.width = Math.max(0, ai.health) + '%';
        }

        function checkWinner() {
            if (player.health <= 0) {
                gameRunning = false;
                losses++;
                messageEl.textContent = 'üíÄ DEFEATED! üíÄ';
                scoreEl.textContent = `Wins: ${wins} | Losses: ${losses}`;
                return true;
            }
            if (ai.health <= 0) {
                gameRunning = false;
                wins++;
                messageEl.textContent = 'üèÜ VICTORY! üèÜ';
                scoreEl.textContent = `Wins: ${wins} | Losses: ${losses}`;
                return true;
            }
            return false;
        }

        function gameLoop() {
            if (!gameRunning) return;

            updatePlayer();
            updateAI();
            checkCollisions();
            draw();

            if (!checkWinner()) {
                requestAnimationFrame(gameLoop);
            }
        }

        // Initial draw
        draw();
    </script>
</body>
</html>
