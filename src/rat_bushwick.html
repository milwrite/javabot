<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üêÄ RAT_BUSHWICK: A Rodent's Guide to Dining üêÄ</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'VT323', monospace;
            background: #0a0a0a;
            color: #00ff9f;
            overflow-x: hidden;
            min-height: 100vh;
            text-shadow: 0 0 8px rgba(0, 255, 159, 0.3);
        }

        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;;
            pointer-events: none;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.15),
                rgba(0, 0, 0, 0.15) 1px,
                transparent 1px,
                transparent 2px
            );
            z-index: 9998;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            border-bottom: 3px solid #00ff9f;
            box-shadow: 0 0 20px rgba(0, 255, 159, 0.4);
            animation: glitch 3s infinite;
        }

        @keyframes glitch {
            0%, 100% { text-shadow: 0 0 10px rgba(0, 255, 159, 0.5); }
            50% { text-shadow: 0 0 20px rgba(255, 85, 255, 0.5), 0 0 10px rgba(0, 255, 159, 0.3); }
        }

        h1 {
            font-family: 'Courier Prime', monospace;
            font-size: 2.5em;
            margin-bottom: 10px;
            letter-spacing: 2px;
            font-weight: 700;
        }

        .subtitle {
            font-size: 1.2em;
            color: #ff55ff;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 49%, 100% { opacity: 1; }
            50%, 99% { opacity: 0.3; }
        }

        .rat-intro {
            text-align: center;
            margin: 30px 0;
            font-size: 1.5em;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 40px 0;
        }

        .menu-item {
            background: #1a1a1a;
            border: 2px solid #00ff9f;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 255, 159, 0.3);
        }

        .menu-item:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(0, 255, 159, 0.7);
            border-color: #ff55ff;
        }

        .menu-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 0, 127, 0.3), transparent);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        .menu-item h3 {
            font-family: 'Courier Prime', monospace;
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #ff55ff;
            position: relative;
            z-index: 1;
        }

        .menu-item p {
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 15px;
            position: relative;
            z-index: 1;
        }

        .ascii-art {
            background: #000;
            border: 1px solid #7ec8e3;
            padding: 10px;
            margin: 15px 0;
            font-size: 0.7em;
            overflow-x: auto;
            white-space: pre;
            color: #7ec8e3;
            line-height: 1.2;
        }

        .difficulty {
            display: inline-block;
            background: #ff006e;
            color: #000;
            padding: 5px 10px;
            font-weight: bold;
            margin-top: 10px;
            position: relative;
            z-index: 1;
        }

        .btn {
            background: #ff006e;
            color: #000;
            border: 2px solid #7ec8e3;
            padding: 10px 20px;
            font-family: 'Courier Prime', monospace;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
            margin-top: 10px;
        }

        .btn:hover {
            background: #7ec8e3;
            box-shadow: 0 0 20px rgba(126, 200, 227, 0.8);
            transform: scale(1.1);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            margin: 5% auto;
            padding: 30px;
            border: 3px solid #7ec8e3;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 0 40px rgba(126, 200, 227, 0.5);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #ff006e;
            float: right;
            font-size: 2em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .close:hover {
            color: #7ec8e3;
            text-shadow: 0 0 10px rgba(126, 200, 227, 0.8);
        }

        .modal h2 {
            font-family: 'Courier Prime', monospace;
            color: #ff006e;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .modal-ascii {
            background: #000;
            border: 1px solid #7ec8e3;
            padding: 15px;
            margin: 20px 0;
            font-size: 0.65em;
            overflow-x: auto;
            white-space: pre;
            color: #7ec8e3;
            line-height: 1.1;
        }

        .achievement {
            background: linear-gradient(135deg, #ff006e, #ffbe0b);
            color: #000;
            padding: 15px;
            margin: 15px 0;
            border: 2px solid #7ec8e3;
            font-weight: bold;
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .stat-box {
            background: #0f3460;
            border: 2px solid #7ec8e3;
            padding: 15px;
            text-align: center;
            box-shadow: 0 0 10px rgba(126, 200, 227, 0.2);
        }

        .stat-box .label {
            color: #ff006e;
            font-size: 0.8em;
            margin-bottom: 10px;
        }

        .stat-box .value {
            font-size: 1.8em;
            color: #7ec8e3;
        }

        .rat-pixel {
            display: inline-block;
            width: 20px;
            height: 20px;
            background: #ff006e;
            margin: 0 2px;
            animation: hop 0.5s ease-in-out infinite;
        }

        @keyframes hop {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .mini-game {
            background: #000;
            border: 3px solid #7ec8e3;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-canvas {
            width: 100%;
            max-width: 400px;
            height: 300px;
            background: #1a1a2e;
            border: 2px solid #7ec8e3;
            position: relative;
            overflow: hidden;
            margin: 15px 0;
        }

        .pizza-slice {
            position: absolute;
            width: 30px;
            height: 30px;
            background: #ff9500;
            border: 1px solid #ffb700;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
        }

        .rat-player {
            position: absolute;
            width: 20px;
            height: 20px;
            background: #ff006e;
            border-radius: 50%;
        }

        .rat-player::after {
            content: '';
            position: absolute;
            width: 10px;
            height: 5px;
            background: #ff006e;
            right: -8px;
            top: 5px;
            border-radius: 50%;
        }

        .rat-player::before {
            content: '';
            position: absolute;
            width: 3px;
            height: 3px;
            background: #000;
            top: 8px;
            left: 8px;
            border-radius: 50%;
        }

        .leaderboard {
            background: #0f3460;
            border: 2px solid #7ec8e3;
            padding: 20px;
            margin: 30px 0;
        }

        .leaderboard h3 {
            color: #ff006e;
            font-family: 'Courier Prime', monospace;
            margin-bottom: 15px;
        }

        .leaderboard-entry {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(126, 200, 227, 0.2);
            align-items: center;
        }

        .leaderboard-entry:last-child {
            border-bottom: none;
        }

        .rank {
            color: #ff006e;
            font-weight: bold;
            min-width: 40px;
        }

        .score {
            color: #ffbe0b;
            font-weight: bold;
        }

        .footer {
            text-align: center;
            padding: 40px 20px;
            border-top: 2px solid #7ec8e3;
            margin-top: 60px;
            font-size: 0.9em;
        }

        .warning {
            background: #ff006e;
            color: #000;
            padding: 15px;
            margin: 20px 0;
            border: 2px solid #ffbe0b;
            font-weight: bold;
            animation: blink 0.5s infinite;
        }

        .mobile-game-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 220px;
            margin: 20px auto 0;
        }

        .control-row {
            display: contents;
        }

        .game-control-btn {
            min-width: 64px;
            min-height: 64px;
            font-size: 28px;
            background: rgba(0, 255, 159, 0.3);
            color: #00ff9f;
            border: 3px solid #00ff9f;
            border-radius: 8px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            touch-action: manipulation;
            transition: all 0.1s;
            font-weight: bold;
        }

        .game-control-btn:active {
            background: #00ff9f;
            color: #000;
            transform: scale(0.95);
        }

        .game-control-btn[data-dir="up"] {
            grid-column: 2;
            grid-row: 1;
        }

        .game-control-btn[data-dir="left"] {
            grid-column: 1;
            grid-row: 2;
        }

        .game-control-btn[data-dir="down"] {
            grid-column: 2;
            grid-row: 2;
        }

        .game-control-btn[data-dir="right"] {
            grid-column: 3;
            grid-row: 2;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.5em;
            }
            .menu-grid {
                grid-template-columns: 1fr;
            }
            .modal-content {
                width: 95%;
                margin: 20% auto;
            }
            .mobile-game-controls {
                display: block;
            }
            .game-canvas {
                max-width: 95vw;
                height: 250px;
            }
        }
    </style>

</head>
<body>
    <a href="../index.html" style="position:fixed;top:20px;left:20px;z-index:9999;text-decoration:none;background:rgba(255,0,0,0.9);color:#7ec8e3;padding:12px 24px;border:2px solid #7ec8e3;box-shadow:0 0 20px rgba(0,255,65,0.5);font-family:'VT323',monospace;font-size:1.2em;">HOME</a>
    
    <div class="scanlines"></div>

    <header>
        <h1>üêÄ RAT_BUSHWICK üêÄ</h1>
        <p class="subtitle">A RODENT'S GUIDE TO FINE DINING</p>
        <div class="rat-intro">
            <span class="rat-pixel"></span>
            <span class="rat-pixel"></span>
            <span class="rat-pixel"></span>
        </div>
    </header>

    <div class="container">
        <div class="stats">
            <div class="stat-box">
                <div class="label">HUNGER LEVEL</div>
                <div class="value" id="hunger">100%</div>
            </div>
            <div class="stat-box">
                <div class="label">CHEESE COLLECTED</div>
                <div class="value" id="cheese">0</div>
            </div>
            <div class="stat-box">
                <div class="label">PIZZA SLICES</div>
                <div class="value" id="pizza">0</div>
            </div>
            <div class="stat-box">
                <div class="label">DUMPSTER DIVES</div>
                <div class="value" id="dives">0</div>
            </div>
        </div>

        <!-- Breaking News Bulletin -->
        <div class="breaking-news" style="background: linear-gradient(45deg, #ff0000, #ff006e); color: #000; padding: 20px; margin: 20px 0; border: 3px solid #ffbe0b; animation: pulse 1s infinite; font-weight: bold;">
            <div style="text-align: center; font-size: 1.4em; margin-bottom: 10px;">üö® BREAKING NEWS üö®</div>
            <div style="font-size: 1.1em;">STARR STREET INFESTATION CRISIS: Residents report friendly rats "running right up to you" as Hunter Boone contracts giardia from rat exposure. City conducts multiple inspections but residents demand more frequent extermination. Some throwing poison on sidewalks.</div>
            <div style="margin-top: 10px; font-size: 0.9em; text-align: center;">Last City Inspection: September 20th | Health Alert Level: MAXIMUM</div>
        </div>

        <div class="warning">
            ‚ö†Ô∏è WARNING: HUMAN DETECTION IMMINENT ‚ö†Ô∏è<br>
            STAY ALERT. STAY HUNGRY. STAY RAT.
        </div>

        <!-- Mini Game Section - FEATURED -->
        <div class="mini-game" style="margin-bottom: 40px;">
            <h2 style="font-family: 'Courier Prime', monospace; color: #ff006e; margin-bottom: 20px; font-size: 2em;">üéÆ PIZZA COLLECTOR üéÆ</h2>
            <div class="game-canvas" id="gameCanvas" style="max-width: 500px; height: 400px;"></div>

            <!-- Mobile Controls -->
            <div class="mobile-game-controls" id="mobileGameControls">
                <div class="control-row">
                    <button class="game-control-btn" data-dir="up">‚Üë</button>
                </div>
                <div class="control-row">
                    <button class="game-control-btn" data-dir="left">‚Üê</button>
                    <button class="game-control-btn" data-dir="down">‚Üì</button>
                    <button class="game-control-btn" data-dir="right">‚Üí</button>
                </div>
                <button class="game-control-btn" id="hideBtn" style="grid-column: 1 / -1; margin-top: 8px; background: rgba(255, 85, 255, 0.3); border-color: #ff55ff; color: #ff55ff; min-height: 48px;">ü´£ HIDE</button>
            </div>

            <div class="game-stats" style="display: flex; gap: 20px; justify-content: center; margin: 15px 0; font-size: 1.2em;">
                <span style="color: #ffbe0b;">Score: <span id="gameScore">0</span></span>
                <span style="color: #ff006e;">Lives: <span id="gameLives">3</span></span>
                <span style="color: #7ec8e3;">Level: <span id="gameLevel">1</span></span>
            </div>

            <button class="btn" onclick="startGame()" style="font-size: 0.9em; padding: 10px 20px;">START GAME</button>

            <p style="margin-top: 15px; font-size: 1.1em; color: #00ff9f;">Collect üçï pizza! Avoid üê± cats! Grab üßÄ cheese for speed! Press SPACE or tap HIDE to escape!</p>
        </div>

        <h2 style="font-family: 'Courier Prime', monospace; color: #ff006e; text-align: center; margin: 40px 0 30px; font-size: 1.8em; border-top: 2px solid #7ec8e3; padding-top: 30px;">üß© RAT BRAIN TEASERS üß©</h2>

        <div class="menu-grid">
            <!-- Cheese Maze Puzzle -->
            <div class="menu-item">
                <h3>üßÄ CHEESE MAZE</h3>
                <p>Navigate the ASCII maze to reach the legendary cheese wheel!</p>
                <div class="ascii-art">
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
‚ñà üêÄ    ‚ñà
‚ñà ‚ñà‚ñà‚ñà ‚ñà ‚ñà
‚ñà   ‚ñà ‚ñà ‚ñà
‚ñà ‚ñà   ‚ñà ‚ñà
‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà
‚ñà     üßÄ‚ñà
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà</div>
                <div class="difficulty">DIFFICULTY: EASY</div>
                <button class="btn" onclick="openActivity('maze')">SOLVE PUZZLE</button>
            </div>

            <!-- Rat Trivia -->
            <div class="menu-item">
                <h3>üß† RAT TRIVIA</h3>
                <p>Test your knowledge of Bushwick rat culture and survival tactics!</p>
                <div class="ascii-art">
  /\_/\
 ( ?.? )
  > ^ <
 /|   |\
(_|   |_)
 Q: WHAT?</div>
                <div class="difficulty">DIFFICULTY: MEDIUM</div>
                <button class="btn" onclick="openActivity('trivia')">START QUIZ</button>
            </div>

            <!-- Pizza Math -->
            <div class="menu-item">
                <h3>üçï PIZZA MATH</h3>
                <p>Calculate optimal pizza slice ratios for the rat colony!</p>
                <div class="ascii-art">
   8 rats
   3 slices
   = ???

  SOLVE TO
  SURVIVE</div>
                <div class="difficulty">DIFFICULTY: HARD</div>
                <button class="btn" onclick="openActivity('math')">CALCULATE</button>
            </div>

            <!-- Word Scramble -->
            <div class="menu-item">
                <h3>üìù RAT SCRAMBLE</h3>
                <p>Unscramble rat-related words to unlock secret knowledge!</p>
                <div class="ascii-art">
   ~~~
  (o o)
   \ - /
    | |

ZZEIP = ?
EHSECE = ?</div>
                <div class="difficulty">DIFFICULTY: EASY</div>
                <button class="btn" onclick="openActivity('scramble')">UNSCRAMBLE</button>
            </div>

            <!-- Logic Puzzle -->
            <div class="menu-item">
                <h3>üîç RAT LOGIC</h3>
                <p>Deduce which rat stole the pizza using clues and deduction!</p>
                <div class="ascii-art">
  ‚ï≠‚îÄ ‚îÄ‚ïÆ
  ‚îÇ üêÄ ‚îÇ Suspect A
  ‚îÇ üêÄ ‚îÇ Suspect B
  ‚îÇ üêÄ ‚îÇ Suspect C
  ‚ï∞‚îÄ ‚îÄ‚ïØ
  WHO DID IT?</div>
                <div class="difficulty">DIFFICULTY: HARD</div>
                <button class="btn" onclick="openActivity('logic')">INVESTIGATE</button>
            </div>

            <!-- Pattern Recognition -->
            <div class="menu-item">
                <h3>üéØ PATTERN RAT</h3>
                <p>Identify the pattern in rat movements to predict the next location!</p>
                <div class="ascii-art">
üêÄ ‚Üí üßÄ ‚Üí üêÄ
üßÄ ‚Üí üêÄ ‚Üí üßÄ
üêÄ ‚Üí üßÄ ‚Üí ?</div>
                <div class="difficulty">DIFFICULTY: MEDIUM</div>
                <button class="btn" onclick="openActivity('pattern')">FIND PATTERN</button>
            </div>

            <!-- Memory Challenge -->
            <div class="menu-item">
                <h3>üí≠ MEMORY TEST</h3>
                <p>Memorize the locations of hidden cheese stashes!</p>
                <div class="ascii-art">
   ‚óã_‚óã
  /   \
 | ‚óâ ‚óâ |
  \ ‚ñº /
   |_|
  REMEMBER!</div>
                <div class="difficulty">DIFFICULTY: MEDIUM</div>
                <button class="btn" onclick="openActivity('memory')">TEST MEMORY</button>
            </div>

            <!-- Riddles -->
            <div class="menu-item">
                <h3>‚ùì RAT RIDDLES</h3>
                <p>Solve ancient rat riddles passed down through generations!</p>
                <div class="ascii-art">
    ~~~
   (o_o)
    \_/
    /|\

"I run but
never walk..."</div>
                <div class="difficulty">DIFFICULTY: EXTREME</div>
                <button class="btn" onclick="openActivity('riddles')">SOLVE RIDDLES</button>
            </div>
        </div>

        <!-- Leaderboard -->
        <div class="leaderboard">
            <h3>üèÜ BUSHWICK RAT LEADERBOARD üèÜ</h3>
            <div class="leaderboard-entry">
                <div class="rank">1.</div>
                <div>Pizza Rat Supreme</div>
                <div class="score">9,999 pts</div>
            </div>
            <div class="leaderboard-entry">
                <div class="rank">2.</div>
                <div>Dumpster Diver Deluxe</div>
                <div class="score">8,547 pts</div>
            </div>
            <div class="leaderboard-entry">
                <div class="rank">3.</div>
                <div>Bodega Bandit</div>
                <div class="score">7,823 pts</div>
            </div>
            <div class="leaderboard-entry">
                <div class="rank">4.</div>
                <div>Cheese Connoisseur</div>
                <div class="score">6,234 pts</div>
            </div>
            <div class="leaderboard-entry">
                <div class="rank">5.</div>
                <div>You (New Player)</div>
                <div class="score" id="playerScore">0 pts</div>
            </div>
        </div>

        <div class="footer">
            <p>RAT_BUSHWICK v1.0 | Developed by Whisker Industries‚Ñ¢</p>
            <p>Remember: A well-fed rat is a happy rat.</p>
            <p style="margin-top: 20px; font-size: 0.8em;">üêÄ üçï üßÄ üóëÔ∏è üêÄ üçï üßÄ üóëÔ∏è üêÄ üçï üßÄ üóëÔ∏è</p>
        </div>
    </div>

    <!-- Modal for Activities -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeActivity()">&times;</span>
            <h2 id="modalTitle">MISSION BRIEFING</h2>
            <div id="modalBody"></div>
            <button class="btn" onclick="completeActivity()" style="width: 100%; margin-top: 20px;">COMPLETE MISSION</button>
        </div>
    </div>

    <script>
        let gameState = {
            hunger: 100,
            cheese: 0,
            pizza: 0,
            dives: 0,
            totalScore: 0
        };

        let gameRunning = false;
        let playerX = 190;
        let playerY = 250;
        let pizzas = [];
        let cats = [];
        let cheese = [];
        let gameScore = 0;
        let gameLives = 3;
        let gameLevel = 1;
        let nextLevelScore = 100;
        let playerSpeed = 15;
        let speedBoostTimer = 0;
        let isHiding = false;
        let hideTimer = 0;
        let hideCooldown = 0;
        let gameCanvas = null;
        let gameCtx = null;
        let canvasWidth = 400;
        let canvasHeight = 300;
        let mobileControlsSetup = false;

        // Quiz state
        let currentQuestion = 0;
        let quizScore = 0;
        let quizAnswered = false;
        
        // Scramble state
        let currentWord = 0;
        let scrambleScore = 0;
        let scrambleCompleted = [];

        const activities = {
            maze: {
                title: "üßÄ CHEESE MAZE PUZZLE",
                ascii: `
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà
    ‚ñà üêÄ START     ‚ñà
    ‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà ‚ñà
    ‚ñà ‚ñà     ‚ñà   ‚ñà ‚ñà
    ‚ñà ‚ñà ‚ñà‚ñà‚ñà ‚ñà‚ñà‚ñà ‚ñà ‚ñà
    ‚ñà ‚ñà ‚ñà ‚ñà     ‚ñà ‚ñà
    ‚ñà ‚ñà ‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà ‚ñà
    ‚ñà ‚ñà          ‚ñà
    ‚ñà ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñà
    ‚ñà FINISH üßÄ   ‚ñà
    ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà

    PATH FOUND: ‚Üì‚Üí‚Üí‚Üì‚Üì‚Üí‚Üì‚Üí‚Üí‚Üë‚Üí‚Üì
    SUCCESS!
                `,
                reward: 'Maze solved! +5 cheese, +20 IQ points'
            },
            trivia: {
                title: "üß† RAT TRIVIA CHALLENGE",
                questions: [
                    {
                        question: "What year did the famous NYC Pizza Rat video go viral?",
                        options: ["2014", "2015", "2016", "2017"],
                        correct: 1,
                        explanation: "Pizza Rat became an internet sensation in September 2015!"
                    },
                    {
                        question: "According to recent news, which Bushwick street is overrun with rats?",
                        options: ["Graham Avenue", "Starr Street", "Morgan Avenue", "Grand Street"],
                        correct: 1,
                        explanation: "Starr Street residents are dealing with a major rat infestation crisis."
                    },
                    {
                        question: "What disease did Hunter Boone contract from rat exposure?",
                        options: ["Salmonella", "Giardia", "Hantavirus", "Leptospirosis"],
                        correct: 1,
                        explanation: "Giardia is a parasite that can be transmitted through contaminated feces."
                    },
                    {
                        question: "How many chambers does a rat's heart have?",
                        options: ["2", "3", "4", "5"],
                        correct: 2,
                        explanation: "Rats have 4-chambered hearts, just like humans!"
                    },
                    {
                        question: "What are rats doing in Bushwick according to residents?",
                        options: ["Hiding from humans", "Running right up to you", "Only coming out at night", "Staying in sewers"],
                        correct: 1,
                        explanation: "One resident quipped: 'Oh no, they're friendly. They'll run right up to you.'"
                    }
                ],
                reward: 'Quiz master! +15 cheese, +1 achievement'
            },
            math: {
                title: "üçï PIZZA MATH PROBLEM",
                ascii: `
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë CALCULATION   ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    8 rats share 3 slices
    Each slice = 8 pieces

    3 √ó 8 = 24 pieces
    24 √∑ 8 = 3 pieces/rat

    ANSWER: 3 pieces each!
    SOLUTION: CORRECT ‚úì
                `,
                reward: 'Math genius! +10 cheese, +25 IQ points'
            },
            scramble: {
                title: "üìù RAT WORD SCRAMBLE",
                words: [
                    { scrambled: "ZZEIP", answer: "PIZZA", hint: "Rat's favorite round food" },
                    { scrambled: "EHSECE", answer: "CHEESE", hint: "Yellow treasure from the deli" },
                    { scrambled: "ARUBGES", answer: "GARBAGE", hint: "Rat's buffet location" },
                    { scrambled: "KBWHSCUI", answer: "BUSHWICK", hint: "Brooklyn neighborhood with friendly rats" },
                    { scrambled: "RAST TEERTS", answer: "STARR STREET", hint: "Recent rat infestation hotspot" }
                ],
                reward: 'Word master! +12 cheese, +1 achievement'
            },
            logic: {
                title: "üîç RAT DETECTIVE LOGIC",
                ascii: `
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë CLUES:        ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    1. Suspect A was sleeping
    2. Suspect B hates pizza
    3. Suspect C loves pizza
    4. Pizza vanished at 2am

    DEDUCTION: Suspect C!
    CASE SOLVED ‚úì
                `,
                reward: 'Mystery solved! +18 cheese, Detective Badge unlocked'
            },
            pattern: {
                title: "üéØ PATTERN RECOGNITION",
                ascii: `
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë FIND PATTERN  ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    üêÄ ‚Üí üßÄ ‚Üí üêÄ
    üßÄ ‚Üí üêÄ ‚Üí üßÄ
    üêÄ ‚Üí üßÄ ‚Üí [üêÄ]

    PATTERN: Alternating!
    ANSWER: üêÄ ‚úì
    GENIUS LEVEL!
                `,
                reward: 'Pattern mastered! +14 cheese, +30 IQ points'
            },
            memory: {
                title: "üí≠ MEMORY CHALLENGE",
                ascii: `
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë MEMORIZE:     ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    üßÄ ‚ñë ‚ñë üßÄ ‚ñë
    ‚ñë üßÄ ‚ñë ‚ñë üßÄ
    üßÄ ‚ñë üßÄ ‚ñë ‚ñë

    [3 seconds later...]

    ALL LOCATIONS RECALLED!
    PERFECT MEMORY ‚úì
                `,
                reward: 'Memory master! +16 cheese, Photographic Memory badge'
            },
            riddles: {
                title: "‚ùì ANCIENT RAT RIDDLES",
                ascii: `
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë RIDDLE:       ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

    "I run but never walk,
    have a mouth but never talk,
    have a bed but never sleep"

    ANSWER: A RIVER ‚úì

    ANCIENT WISDOM UNLOCKED!
                `,
                reward: 'Riddle solved! +20 cheese, Wisdom of the Elders unlocked'
            }
        };

        function openActivity(activity) {
            const data = activities[activity];
            document.getElementById('modalTitle').textContent = data.title;
            
            if (activity === 'trivia') {
                startTrivia();
            } else if (activity === 'scramble') {
                startScramble();
            } else {
                document.getElementById('modalBody').innerHTML = `
                    <div class="modal-ascii">${data.ascii}</div>
                    <p style="margin: 20px 0;">${data.reward}</p>
                `;
            }
            
            document.getElementById('activityModal').style.display = 'block';
            document.getElementById('activityModal').dataset.activity = activity;
        }

        function startTrivia() {
            currentQuestion = 0;
            quizScore = 0;
            quizAnswered = false;
            showQuestion();
        }

        function showQuestion() {
            const questions = activities.trivia.questions;
            const q = questions[currentQuestion];
            
            document.getElementById('modalBody').innerHTML = `
                <div style="background: #000; border: 2px solid #7ec8e3; padding: 20px; margin: 20px 0;">
                    <div style="color: #ffbe0b; margin-bottom: 15px; text-align: center;">
                        QUESTION ${currentQuestion + 1}/${questions.length}
                    </div>
                    <div style="color: #00ff9f; font-size: 1.2em; margin-bottom: 20px;">
                        ${q.question}
                    </div>
                    <div id="quizOptions" style="display: grid; gap: 10px;">
                        ${q.options.map((option, index) => `
                            <button onclick="answerQuestion(${index})" 
                                    style="background: rgba(126, 200, 227, 0.2); 
                                           border: 2px solid #7ec8e3; 
                                           color: #7ec8e3; 
                                           padding: 12px; 
                                           cursor: pointer; 
                                           font-family: 'Courier Prime', monospace;
                                           font-size: 1em;
                                           transition: all 0.3s ease;"
                                    onmouseover="this.style.background='rgba(126, 200, 227, 0.4)'"
                                    onmouseout="this.style.background='rgba(126, 200, 227, 0.2)'">
                                ${String.fromCharCode(65 + index)}) ${option}
                            </button>
                        `).join('')}
                    </div>
                    <div id="quizFeedback" style="margin-top: 20px; min-height: 50px; color: #ff55ff;"></div>
                    <div style="text-align: center; margin-top: 20px;">
                        Score: <span style="color: #ffbe0b;">${quizScore}/${questions.length}</span>
                    </div>
                </div>
            `;
            
            // Hide the complete button initially
            document.querySelector('.modal .btn').style.display = 'none';
        }

        function answerQuestion(selectedIndex) {
            if (quizAnswered) return;
            
            quizAnswered = true;
            const questions = activities.trivia.questions;
            const q = questions[currentQuestion];
            const isCorrect = selectedIndex === q.correct;
            
            if (isCorrect) {
                quizScore++;
            }
            
            // Update button colors
            const options = document.querySelectorAll('#quizOptions button');
            options.forEach((btn, index) => {
                if (index === q.correct) {
                    btn.style.background = '#00ff41';
                    btn.style.color = '#000';
                    btn.style.borderColor = '#00ff41';
                } else if (index === selectedIndex && !isCorrect) {
                    btn.style.background = '#ff0000';
                    btn.style.color = '#fff';
                    btn.style.borderColor = '#ff0000';
                }
                btn.style.cursor = 'default';
                btn.onclick = null;
            });
            
            // Show feedback
            const feedback = document.getElementById('quizFeedback');
            feedback.innerHTML = `
                <div style="color: ${isCorrect ? '#00ff41' : '#ff0000'}; font-weight: bold; margin-bottom: 10px;">
                    ${isCorrect ? '‚úì CORRECT!' : '‚úó INCORRECT!'}
                </div>
                <div style="color: #7ec8e3; font-size: 0.9em;">
                    ${q.explanation}
                </div>
            `;
            
            // Show next button or complete quiz
            setTimeout(() => {
                if (currentQuestion < questions.length - 1) {
                    feedback.innerHTML += `
                        <button onclick="nextQuestion()" 
                                style="background: #ff006e; 
                                       color: #000; 
                                       border: 2px solid #7ec8e3; 
                                       padding: 10px 20px; 
                                       margin-top: 15px; 
                                       cursor: pointer; 
                                       font-family: 'Courier Prime', monospace;">
                            NEXT QUESTION ‚Üí
                        </button>
                    `;
                } else {
                    feedback.innerHTML += `
                        <button onclick="completeTrivia()" 
                                style="background: #ffbe0b; 
                                       color: #000; 
                                       border: 2px solid #7ec8e3; 
                                       padding: 10px 20px; 
                                       margin-top: 15px; 
                                       cursor: pointer; 
                                       font-family: 'Courier Prime', monospace;">
                            COMPLETE QUIZ üèÜ
                        </button>
                    `;
                }
            }, 1500);
        }

        function nextQuestion() {
            currentQuestion++;
            quizAnswered = false;
            showQuestion();
        }

        function completeTrivia() {
            const questions = activities.trivia.questions;
            let message = '';
            let reward = 0;
            
            if (quizScore === questions.length) {
                message = 'üèÜ PERFECT SCORE! You are a true rat scholar!';
                reward = 25;
            } else if (quizScore >= questions.length * 0.8) {
                message = 'üéØ EXCELLENT! You know your rat facts!';
                reward = 20;
            } else if (quizScore >= questions.length * 0.6) {
                message = 'üëç GOOD JOB! Keep learning about rat life!';
                reward = 15;
            } else {
                message = 'üìö STUDY MORE! But you tried your best!';
                reward = 10;
            }
            
            document.getElementById('modalBody').innerHTML = `
                <div style="background: #000; border: 2px solid #7ec8e3; padding: 30px; text-align: center;">
                    <div style="color: #ffbe0b; font-size: 2em; margin-bottom: 20px;">QUIZ COMPLETE!</div>
                    <div style="color: #00ff9f; font-size: 1.4em; margin-bottom: 15px;">
                        Final Score: ${quizScore}/${questions.length}
                    </div>
                    <div style="color: #ff55ff; font-size: 1.1em; margin-bottom: 20px;">
                        ${message}
                    </div>
                    <div style="color: #7ec8e3;">
                        Reward: +${reward} cheese!
                    </div>
                </div>
            `;
            
            // Add reward to game state
            gameState.cheese += reward;
            gameState.totalScore += reward * 10;
            updateStats();
            
            // Show the close button
            document.querySelector('.modal .btn').style.display = 'block';
            document.querySelector('.modal .btn').textContent = 'CLOSE';
        }

        function startScramble() {
            currentWord = 0;
            scrambleScore = 0;
            scrambleCompleted = new Array(activities.scramble.words.length).fill(false);
            showScrambleGrid();
        }

        function showScrambleGrid() {
            const words = activities.scramble.words;
            
            document.getElementById('modalBody').innerHTML = `
                <div style="background: #000; border: 2px solid #7ec8e3; padding: 20px; margin: 20px 0;">
                    <div style="color: #ffbe0b; margin-bottom: 15px; text-align: center; font-size: 1.3em;">
                        üî§ UNSCRAMBLE THE RAT WORDS üî§
                    </div>
                    <div style="color: #7ec8e3; margin-bottom: 20px; text-align: center;">
                        Complete all words to win! Click hints for help.
                    </div>
                    
                    <div style="display: grid; gap: 15px;">
                        ${words.map((word, index) => `
                            <div style="background: rgba(126, 200, 227, 0.1); border: 2px solid #7ec8e3; padding: 15px; border-radius: 5px;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <span style="color: #ff55ff; font-size: 1.2em; font-weight: bold;">${word.scrambled}</span>
                                    <span style="color: #ffbe0b;">‚Üí</span>
                                    <input type="text" id="answer${index}" 
                                           style="background: #0a0a0a; border: 2px solid #00ff9f; color: #00ff9f; padding: 8px; font-family: 'Courier Prime', monospace; text-transform: uppercase;"
                                           placeholder="ANSWER"
                                           ${scrambleCompleted[index] ? 'disabled' : ''}
                                           onkeyup="checkScrambleAnswer(${index}, this.value)"
                                           autocomplete="off">
                                    ${scrambleCompleted[index] ? '<span style="color: #00ff41; font-size: 1.5em;">‚úì</span>' : ''}
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <button onclick="showHint(${index})" 
                                            style="background: rgba(255, 85, 255, 0.3); border: 1px solid #ff55ff; color: #ff55ff; padding: 5px 10px; font-size: 0.8em; cursor: pointer; font-family: 'Courier Prime', monospace;">
                                        üí° HINT
                                    </button>
                                    <div id="hint${index}" style="color: #ff55ff; font-size: 0.9em; font-style: italic; opacity: 0; transition: opacity 0.3s;"></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; color: #ffbe0b; font-size: 1.1em;">
                        Progress: <span id="scrambleProgress">${scrambleScore}/${words.length}</span>
                    </div>
                </div>
            `;
            
            // Hide the complete button initially
            document.querySelector('.modal .btn').style.display = 'none';
            
            // Pre-fill completed answers
            words.forEach((word, index) => {
                if (scrambleCompleted[index]) {
                    document.getElementById(`answer${index}`).value = word.answer;
                }
            });
        }

        function showHint(index) {
            const word = activities.scramble.words[index];
            const hintElement = document.getElementById(`hint${index}`);
            hintElement.textContent = word.hint;
            hintElement.style.opacity = '1';
        }

        function checkScrambleAnswer(index, userAnswer) {
            const word = activities.scramble.words[index];
            const cleanAnswer = userAnswer.trim().toUpperCase();
            
            if (cleanAnswer === word.answer && !scrambleCompleted[index]) {
                scrambleCompleted[index] = true;
                scrambleScore++;
                
                // Mark as correct
                const input = document.getElementById(`answer${index}`);
                input.style.borderColor = '#00ff41';
                input.style.color = '#00ff41';
                input.disabled = true;
                
                // Add checkmark
                const parent = input.parentElement;
                if (!parent.querySelector('.checkmark')) {
                    const checkmark = document.createElement('span');
                    checkmark.className = 'checkmark';
                    checkmark.style.cssText = 'color: #00ff41; font-size: 1.5em; margin-left: 10px;';
                    checkmark.textContent = '‚úì';
                    parent.appendChild(checkmark);
                }
                
                // Update progress
                document.getElementById('scrambleProgress').textContent = `${scrambleScore}/${activities.scramble.words.length}`;
                
                // Check if all completed
                if (scrambleScore === activities.scramble.words.length) {
                    setTimeout(completeScramble, 500);
                }
            }
        }

        function completeScramble() {
            document.getElementById('modalBody').innerHTML = `
                <div style="background: #000; border: 2px solid #7ec8e3; padding: 30px; text-align: center;">
                    <div style="color: #ffbe0b; font-size: 2em; margin-bottom: 20px;">üéâ ALL WORDS UNSCRAMBLED! üéâ</div>
                    <div style="color: #00ff9f; font-size: 1.4em; margin-bottom: 15px;">
                        You solved all ${activities.scramble.words.length} word puzzles!
                    </div>
                    <div style="color: #ff55ff; font-size: 1.1em; margin-bottom: 20px;">
                        üèÜ WORD MASTER ACHIEVED! üèÜ
                    </div>
                    <div style="color: #7ec8e3;">
                        Reward: +12 cheese!
                    </div>
                </div>
            `;
            
            // Add reward to game state
            gameState.cheese += 12;
            gameState.totalScore += 120;
            updateStats();
            
            // Show achievement
            showAchievement('WORD_MASTER', 'You unscrambled all the rat words!');
            
            // Show the close button
            document.querySelector('.modal .btn').style.display = 'block';
            document.querySelector('.modal .btn').textContent = 'CLOSE';
        }

        function closeActivity() {
            document.getElementById('activityModal').style.display = 'none';
            
            // Reset complete button
            document.querySelector('.modal .btn').textContent = 'COMPLETE MISSION';
            document.querySelector('.modal .btn').onclick = completeActivity;
        }

        function completeActivity() {
            const activity = document.getElementById('activityModal').dataset.activity;
            const rewards = {
                dumpster: { hunger: -50, cheese: 10, pizza: 0, dives: 1 },
                pizza: { hunger: -60, cheese: 0, pizza: 5, dives: 0 },
                bodega: { hunger: -40, cheese: 15, pizza: 0, dives: 0 },
                bakery: { hunger: -80, cheese: 20, pizza: 0, dives: 0 },
                subway: { hunger: -55, cheese: 8, pizza: 2, dives: 0 },
                taco: { hunger: -70, cheese: 12, pizza: 3, dives: 0 },
                vendor: { hunger: -35, cheese: 6, pizza: 0, dives: 0 },
                rooftop: { hunger: -90, cheese: 25, pizza: 5, dives: 0 }
            };

            const reward = rewards[activity];
            gameState.hunger = Math.max(0, gameState.hunger + reward.hunger);
            gameState.cheese += reward.cheese;
            gameState.pizza += reward.pizza;
            gameState.dives += reward.dives;
            gameState.totalScore += (reward.cheese * 10) + (reward.pizza * 20);

            updateStats();
            closeActivity();

            // Show achievement
            if (gameState.totalScore > 500) {
                showAchievement('RAT_MASTER_UNLOCKED', 'You are now a true Bushwick Rat!');
            }
        }

        function updateStats() {
            document.getElementById('hunger').textContent = gameState.hunger + '%';
            document.getElementById('cheese').textContent = gameState.cheese;
            document.getElementById('pizza').textContent = gameState.pizza;
            document.getElementById('dives').textContent = gameState.dives;
            document.getElementById('playerScore').textContent = gameState.totalScore + ' pts';
        }

        function showAchievement(title, desc) {
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.innerHTML = `<strong>üèÜ ${title}</strong><br>${desc}`;
            document.querySelector('.container').insertBefore(achievement, document.querySelector('.menu-grid'));
            setTimeout(() => achievement.remove(), 3000);
        }

        function startGame() {
            gameCanvas = document.getElementById('gameCanvas');
            canvasWidth = gameCanvas.offsetWidth;
            canvasHeight = gameCanvas.offsetHeight;

            // Create actual canvas element
            let canvas = gameCanvas.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                gameCanvas.appendChild(canvas);
            }
            gameCtx = canvas.getContext('2d');

            gameRunning = true;
            gameScore = 0;
            gameLives = 3;
            gameLevel = 1;
            nextLevelScore = 100;
            playerSpeed = 15;
            speedBoostTimer = 0;
            isHiding = false;
            hideTimer = 0;
            hideCooldown = 0;
            playerX = canvasWidth / 2 - 10;
            playerY = canvasHeight - 40;
            pizzas = [];
            cats = [];
            cheese = [];

            // Generate initial pizzas
            for (let i = 0; i < 5; i++) {
                spawnPizza();
            }

            // Spawn initial cat
            spawnCat();

            // Spawn cheese power-up
            spawnCheese();

            // Remove old listener first, then add new one
            document.removeEventListener('keydown', handleGameInput);
            document.addEventListener('keydown', handleGameInput);

            // Setup mobile controls (only once)
            if (!mobileControlsSetup) {
                setupMobileControls();
                mobileControlsSetup = true;
            }

            updateGameUI();
            updateHideButtonState();
            gameLoop();
        }

        function spawnPizza() {
            pizzas.push({
                x: Math.random() * (canvasWidth - 25),
                y: Math.random() * (canvasHeight - 25)
            });
        }

        function spawnCat() {
            const side = Math.floor(Math.random() * 4);
            let x, y, vx, vy;
            const speed = 0.5 + (gameLevel * 0.15);

            switch(side) {
                case 0: // top
                    x = Math.random() * canvasWidth;
                    y = 0;
                    vx = (Math.random() - 0.5) * speed;
                    vy = Math.random() * speed;
                    break;
                case 1: // right
                    x = canvasWidth;
                    y = Math.random() * canvasHeight;
                    vx = -Math.random() * speed;
                    vy = (Math.random() - 0.5) * speed;
                    break;
                case 2: // bottom
                    x = Math.random() * canvasWidth;
                    y = canvasHeight;
                    vx = (Math.random() - 0.5) * speed;
                    vy = -Math.random() * speed;
                    break;
                default: // left
                    x = 0;
                    y = Math.random() * canvasHeight;
                    vx = Math.random() * speed;
                    vy = (Math.random() - 0.5) * speed;
            }

            cats.push({ x, y, vx, vy, size: 25 });
        }

        function spawnCheese() {
            if (cheese.length < 2) {
                cheese.push({
                    x: Math.random() * (canvasWidth - 20),
                    y: Math.random() * (canvasHeight - 20),
                    timer: 300
                });
            }
        }

        function setupMobileControls() {
            const buttons = document.querySelectorAll('.game-control-btn[data-dir]');
            buttons.forEach(btn => {
                const dir = btn.dataset.dir;

                // Touch events
                btn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    movePlayer(dir);
                });

                // Click events for desktop testing
                btn.addEventListener('click', () => movePlayer(dir));
            });

            // Hide button
            const hideBtn = document.getElementById('hideBtn');
            hideBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                updateHideButtonState();
                toggleHide();
            });
            hideBtn.addEventListener('click', () => {
                updateHideButtonState();
                toggleHide();
            });
        }

        function updateHideButtonState() {
            const hideBtn = document.getElementById('hideBtn');
            if (!gameRunning) {
                hideBtn.style.opacity = '0.5';
                hideBtn.textContent = 'ü´£ HIDE';
                return;
            }
            
            if (hideCooldown > 0) {
                hideBtn.style.opacity = '0.5';
                hideBtn.textContent = `ü´£ HIDE (${Math.ceil(hideCooldown / 60)}s)`;
            } else if (isHiding) {
                hideBtn.style.opacity = '0.7';
                hideBtn.textContent = `ü´£ HIDING (${Math.ceil(hideTimer / 60)}s)`;
            } else {
                hideBtn.style.opacity = '1.0';
                hideBtn.textContent = 'ü´£ HIDE';
            }
        }

        function toggleHide() {
            if (!gameRunning || hideCooldown > 0 || isHiding) return;

            isHiding = true;
            hideTimer = 120; // 2 seconds at 60fps
            hideCooldown = 300; // 5 second cooldown
        }

        function movePlayer(dir) {
            if (!gameRunning) return;
            const speed = speedBoostTimer > 0 ? playerSpeed * 1.5 : playerSpeed;

            switch(dir) {
                case 'up':
                    if (playerY > 0) playerY -= speed;
                    break;
                case 'down':
                    if (playerY < canvasHeight - 20) playerY += speed;
                    break;
                case 'left':
                    if (playerX > 0) playerX -= speed;
                    break;
                case 'right':
                    if (playerX < canvasWidth - 20) playerX += speed;
                    break;
            }
        }

        function handleGameInput(e) {
            if (!gameRunning) return;

            const dirMap = {
                'ArrowUp': 'up', 'w': 'up', 'W': 'up',
                'ArrowDown': 'down', 's': 'down', 'S': 'down',
                'ArrowLeft': 'left', 'a': 'left', 'A': 'left',
                'ArrowRight': 'right', 'd': 'right', 'D': 'right'
            };

            if (dirMap[e.key]) {
                e.preventDefault();
                movePlayer(dirMap[e.key]);
            } else if (e.key === ' ') {
                e.preventDefault();
                toggleHide();
            }
        }

        function updateGameUI() {
            document.getElementById('gameScore').textContent = gameScore;
            document.getElementById('gameLives').textContent = gameLives;
            document.getElementById('gameLevel').textContent = gameLevel;
        }

        function checkCollision(ax, ay, aw, ah, bx, by, bw, bh) {
            return ax < bx + bw && ax + aw > bx && ay < by + bh && ay + ah > by;
        }

        function gameLoop() {
            if (!gameRunning) return;

            // Clear canvas with noir background
            gameCtx.fillStyle = '#0a0a0a';
            gameCtx.fillRect(0, 0, canvasWidth, canvasHeight);

            // Draw grid
            gameCtx.strokeStyle = 'rgba(126, 200, 227, 0.1)';
            gameCtx.lineWidth = 1;
            for (let i = 0; i < canvasWidth; i += 20) {
                gameCtx.beginPath();
                gameCtx.moveTo(i, 0);
                gameCtx.lineTo(i, canvasHeight);
                gameCtx.stroke();
            }
            for (let i = 0; i < canvasHeight; i += 20) {
                gameCtx.beginPath();
                gameCtx.moveTo(0, i);
                gameCtx.lineTo(canvasWidth, i);
                gameCtx.stroke();
            }

            // Speed boost timer
            if (speedBoostTimer > 0) {
                speedBoostTimer--;
                // Draw speed indicator
                gameCtx.fillStyle = '#ffbe0b';
                gameCtx.fillRect(10, 10, (speedBoostTimer / 180) * 100, 8);
            }

            // Draw and update pizzas (iterate backwards to safely remove)
            for (let i = pizzas.length - 1; i >= 0; i--) {
                const pizza = pizzas[i];
                // Pizza slice triangle
                gameCtx.fillStyle = '#ff9500';
                gameCtx.beginPath();
                gameCtx.moveTo(pizza.x + 10, pizza.y);
                gameCtx.lineTo(pizza.x + 20, pizza.y + 20);
                gameCtx.lineTo(pizza.x, pizza.y + 20);
                gameCtx.closePath();
                gameCtx.fill();
                gameCtx.strokeStyle = '#ffb700';
                gameCtx.lineWidth = 2;
                gameCtx.stroke();

                // Check collision with player
                if (checkCollision(playerX, playerY, 20, 20, pizza.x, pizza.y, 20, 20)) {
                    gameScore += 10 * gameLevel;
                    pizzas.splice(i, 1);
                    spawnPizza();

                    // Level up when reaching threshold
                    if (gameScore >= nextLevelScore) {
                        gameLevel++;
                        nextLevelScore += 100 * gameLevel; // Increasing threshold
                        spawnCat();
                    }

                    updateGameUI();
                }
            }

            // Draw and update cheese power-ups (iterate backwards)
            for (let i = cheese.length - 1; i >= 0; i--) {
                const c = cheese[i];
                c.timer--;
                if (c.timer <= 0) {
                    cheese.splice(i, 1);
                    continue;
                }

                // Flashing when about to disappear
                if (c.timer < 60 && Math.floor(c.timer / 10) % 2 === 0) continue;

                // Draw cheese wedge
                gameCtx.fillStyle = '#ffbe0b';
                gameCtx.beginPath();
                gameCtx.arc(c.x + 10, c.y + 10, 10, 0, Math.PI * 2);
                gameCtx.fill();
                gameCtx.fillStyle = '#0a0a0a';
                gameCtx.beginPath();
                gameCtx.arc(c.x + 8, c.y + 8, 2, 0, Math.PI * 2);
                gameCtx.arc(c.x + 14, c.y + 12, 2, 0, Math.PI * 2);
                gameCtx.fill();

                // Check collision
                if (checkCollision(playerX, playerY, 20, 20, c.x, c.y, 20, 20)) {
                    speedBoostTimer = 180; // 3 seconds at 60fps
                    cheese.splice(i, 1);
                    gameScore += 25;
                    updateGameUI();
                }
            }

            // Spawn cheese occasionally
            if (Math.random() < 0.003) spawnCheese();

            // Draw and update cats (enemies) - iterate backwards for safe removal
            let playerHit = false;
            for (let i = cats.length - 1; i >= 0; i--) {
                const cat = cats[i];
                // Move cat towards player (simple AI)
                const dx = playerX - cat.x;
                const dy = playerY - cat.y;
                const dist = Math.sqrt(dx * dx + dy * dy);
                if (dist > 0) {
                    cat.vx = (dx / dist) * (0.6 + gameLevel * 0.1);
                    cat.vy = (dy / dist) * (0.6 + gameLevel * 0.1);
                }

                cat.x += cat.vx;
                cat.y += cat.vy;

                // Draw cat
                gameCtx.fillStyle = '#ff0000';
                // Body
                gameCtx.beginPath();
                gameCtx.ellipse(cat.x + 12, cat.y + 15, 12, 10, 0, 0, Math.PI * 2);
                gameCtx.fill();
                // Head
                gameCtx.beginPath();
                gameCtx.arc(cat.x + 20, cat.y + 10, 8, 0, Math.PI * 2);
                gameCtx.fill();
                // Ears
                gameCtx.beginPath();
                gameCtx.moveTo(cat.x + 15, cat.y + 5);
                gameCtx.lineTo(cat.x + 18, cat.y - 2);
                gameCtx.lineTo(cat.x + 21, cat.y + 5);
                gameCtx.fill();
                gameCtx.beginPath();
                gameCtx.moveTo(cat.x + 22, cat.y + 5);
                gameCtx.lineTo(cat.x + 25, cat.y - 2);
                gameCtx.lineTo(cat.x + 28, cat.y + 5);
                gameCtx.fill();
                // Eyes
                gameCtx.fillStyle = '#ffbe0b';
                gameCtx.beginPath();
                gameCtx.arc(cat.x + 18, cat.y + 9, 2, 0, Math.PI * 2);
                gameCtx.arc(cat.x + 24, cat.y + 9, 2, 0, Math.PI * 2);
                gameCtx.fill();

                // Check collision with player (only once per frame) - skip if hiding
                if (!playerHit && !isHiding && checkCollision(playerX, playerY, 20, 20, cat.x, cat.y, cat.size, cat.size)) {
                    playerHit = true;
                    gameLives--;
                    updateGameUI();

                    if (gameLives <= 0) {
                        endGame();
                        return; // Stop the game loop
                    }

                    // Reset player position
                    playerX = canvasWidth / 2 - 10;
                    playerY = canvasHeight - 40;

                    // Remove this cat and spawn new one after delay
                    cats.splice(i, 1);
                    setTimeout(spawnCat, 1000);
                }
            }

            // Update hiding and cooldown timers
            if (hideTimer > 0) {
                hideTimer--;
                if (hideTimer === 0) {
                    isHiding = false;
                }
            }
            if (hideCooldown > 0) {
                hideCooldown--;
            }

            // Draw player (rat) with speed boost and hiding effects
            const ratColor = speedBoostTimer > 0 ? '#7ec8e3' : '#ff006e';

            // Hiding indicator - draw box around rat
            if (isHiding) {
                gameCtx.fillStyle = 'rgba(255, 85, 255, 0.3)';
                gameCtx.fillRect(playerX - 5, playerY - 5, 30, 30);
                gameCtx.strokeStyle = '#ff55ff';
                gameCtx.lineWidth = 2;
                gameCtx.strokeRect(playerX - 5, playerY - 5, 30, 30);
                gameCtx.globalAlpha = 0.5; // Semi-transparent when hiding
            }

            gameCtx.fillStyle = ratColor;

            // Body
            gameCtx.beginPath();
            gameCtx.arc(playerX + 10, playerY + 12, 10, 0, Math.PI * 2);
            gameCtx.fill();

            // Ears
            gameCtx.beginPath();
            gameCtx.arc(playerX + 5, playerY + 2, 5, 0, Math.PI * 2);
            gameCtx.fill();
            gameCtx.beginPath();
            gameCtx.arc(playerX + 15, playerY + 2, 5, 0, Math.PI * 2);
            gameCtx.fill();

            // Eye
            gameCtx.fillStyle = '#000';
            gameCtx.beginPath();
            gameCtx.arc(playerX + 12, playerY + 10, 2, 0, Math.PI * 2);
            gameCtx.fill();

            // Nose
            gameCtx.fillStyle = '#ff006e';
            gameCtx.beginPath();
            gameCtx.arc(playerX + 18, playerY + 12, 2, 0, Math.PI * 2);
            gameCtx.fill();

            // Tail
            gameCtx.strokeStyle = ratColor;
            gameCtx.lineWidth = 3;
            gameCtx.beginPath();
            gameCtx.moveTo(playerX + 2, playerY + 18);
            gameCtx.quadraticCurveTo(playerX - 15, playerY + 25, playerX - 20, playerY + 15);
            gameCtx.stroke();

            gameCtx.globalAlpha = 1.0; // Reset opacity

            // Display hide status
            gameCtx.font = '14px VT323';
            gameCtx.textAlign = 'center';
            if (isHiding) {
                gameCtx.fillStyle = '#ff55ff';
                gameCtx.fillText(`HIDING: ${Math.ceil(hideTimer / 60)}s`, canvasWidth / 2, 30);
            } else if (hideCooldown > 0) {
                gameCtx.fillStyle = '#ffbe0b';
                gameCtx.fillText(`Hide Cooldown: ${Math.ceil(hideCooldown / 60)}s`, canvasWidth / 2, 30);
            } else {
                gameCtx.fillStyle = '#00ff9f';
                gameCtx.fillText('HIDE READY!', canvasWidth / 2, 30);
            }
            gameCtx.textAlign = 'left';

            // Update hide button state every frame
            updateHideButtonState();

            requestAnimationFrame(gameLoop);
        }

        function endGame() {
            gameRunning = false;
            document.removeEventListener('keydown', handleGameInput);

            // Draw game over screen
            gameCtx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            gameCtx.fillRect(0, 0, canvasWidth, canvasHeight);

            gameCtx.fillStyle = '#ff0000';
            gameCtx.font = 'bold 24px VT323';
            gameCtx.textAlign = 'center';
            gameCtx.fillText('GAME OVER', canvasWidth / 2, canvasHeight / 2 - 30);

            gameCtx.fillStyle = '#7ec8e3';
            gameCtx.font = '18px VT323';
            gameCtx.fillText(`Final Score: ${gameScore}`, canvasWidth / 2, canvasHeight / 2);
            gameCtx.fillText(`Level Reached: ${gameLevel}`, canvasWidth / 2, canvasHeight / 2 + 25);
            gameCtx.fillText('Click START to play again', canvasWidth / 2, canvasHeight / 2 + 60);
            gameCtx.textAlign = 'left';

            // Add score to game state
            gameState.pizza += Math.floor(gameScore / 10);
            gameState.totalScore += gameScore;
            updateStats();
        }

        function stopGame() {
            gameRunning = false;
            document.removeEventListener('keydown', handleGameInput);
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('activityModal');
            if (event.target === modal) {
                closeActivity();
            }
        }

        // Initialize
        updateStats();

        // Hunger decreases over time
        setInterval(() => {
            if (gameState.hunger > 0) {
                gameState.hunger = Math.max(0, gameState.hunger - 1);
                updateStats();
            }
        }, 5000);
    </script>
</body>
</html>