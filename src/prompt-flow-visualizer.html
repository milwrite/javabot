<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prompt Flow Visualizer - Bot Sportello</title>
    <link rel="stylesheet" href="../page-theme.css">
    <style>
        :root {
            --noir-bg: #0a0a0a;
            --noir-red: #ff0000;
            --noir-cyan: #00ffff;
            --noir-blue: #7ec8e3;
            --noir-text: #e0e0e0;
            --noir-dim: #555;
        }

        body {
            background: var(--noir-bg);
            color: var(--noir-text);
            font-family: 'Courier Prime', monospace;
            min-height: 100vh;
            padding-top: 80px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h1 {
            color: var(--noir-cyan);
            text-align: center;
            font-size: 1.5rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .subtitle {
            text-align: center;
            color: var(--noir-dim);
            font-size: 0.85rem;
            margin-bottom: 20px;
        }

        /* Controls Panel */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid var(--noir-cyan);
            border-radius: 4px;
        }

        .controls label {
            color: var(--noir-cyan);
            font-size: 0.85rem;
        }

        .controls select {
            background: var(--noir-bg);
            color: var(--noir-text);
            border: 1px solid var(--noir-cyan);
            padding: 8px 12px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .controls button {
            background: transparent;
            color: var(--noir-cyan);
            border: 1px solid var(--noir-cyan);
            padding: 8px 16px;
            font-family: inherit;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .controls button:hover {
            background: var(--noir-cyan);
            color: var(--noir-bg);
        }

        .controls button.active {
            background: var(--noir-red);
            border-color: var(--noir-red);
            color: white;
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .speed-control input[type="range"] {
            width: 80px;
            accent-color: var(--noir-cyan);
        }

        /* SVG Diagram */
        .diagram-container {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid var(--noir-cyan);
            border-radius: 4px;
            padding: 10px;
            overflow-x: auto;
            /* center the SVG when it doesn't need to scroll */
            text-align: center;
        }

        #flowDiagram {
            width: 100%;
            height: 450px;
            /* allow shrinking on mobile */
            min-width: 0;
            /* ensure block centering plays nicely with text-align on container */
            display: inline-block;
        }

        /* SVG Node Styles */
        .node-rect {
            fill: var(--noir-bg);
            stroke: var(--noir-cyan);
            stroke-width: 2;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .node-rect:hover {
            stroke: var(--noir-red);
            filter: drop-shadow(0 0 5px var(--noir-red));
        }

        .node-rect.active {
            stroke: var(--noir-red);
            stroke-width: 3;
            filter: drop-shadow(0 0 10px var(--noir-red));
        }

        .node-text {
            fill: var(--noir-text);
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
            pointer-events: none;
        }

        .node-label {
            fill: var(--noir-cyan);
            font-size: 9px;
        }

        .edge {
            stroke: var(--noir-dim);
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .edge.active {
            stroke: var(--noir-red);
            stroke-width: 3;
        }

        .flow-token {
            fill: var(--noir-red);
            filter: drop-shadow(0 0 8px var(--noir-red));
            opacity: 0;
        }

        .flow-token.visible {
            opacity: 1;
        }

        /* Module boxes in diagram */
        .module-box {
            fill: rgba(0, 255, 255, 0.1);
            stroke: var(--noir-cyan);
            stroke-width: 1;
            cursor: pointer;
            transition: all 0.2s;
        }

        .module-box:hover {
            fill: rgba(255, 0, 0, 0.2);
            stroke: var(--noir-red);
        }

        .module-box.highlighted {
            fill: rgba(255, 0, 0, 0.3);
            stroke: var(--noir-red);
            stroke-width: 2;
        }

        .module-text {
            fill: var(--noir-blue);
            font-size: 8px;
            pointer-events: none;
        }

        /* Decision diamond */
        .decision-shape {
            fill: var(--noir-bg);
            stroke: var(--noir-cyan);
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .decision-shape.active {
            stroke: var(--noir-red);
            filter: drop-shadow(0 0 10px var(--noir-red));
        }

        /* Info Panels */
        .panels {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 768px) {
            .panels {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid var(--noir-cyan);
            border-radius: 4px;
            padding: 15px;
        }

        .panel h3 {
            color: var(--noir-cyan);
            font-size: 0.9rem;
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--noir-dim);
            padding-bottom: 8px;
        }

        .module-details {
            min-height: 180px;
        }

        .module-details .placeholder {
            color: var(--noir-dim);
            font-style: italic;
            font-size: 0.85rem;
        }

        .detail-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 0.85rem;
        }

        .detail-label {
            color: var(--noir-cyan);
            width: 80px;
            flex-shrink: 0;
        }

        .detail-value {
            color: var(--noir-text);
        }

        .preview-box {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid var(--noir-dim);
            border-radius: 3px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.75rem;
            line-height: 1.4;
            color: var(--noir-blue);
            max-height: 100px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        /* Stats Panel */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .stat-item {
            text-align: center;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .stat-value {
            font-size: 1.5rem;
            color: var(--noir-red);
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--noir-dim);
            text-transform: uppercase;
            margin-top: 5px;
        }

        .savings-bar {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--noir-dim);
        }

        .savings-bar h4 {
            color: var(--noir-cyan);
            font-size: 0.8rem;
            margin: 0 0 10px 0;
        }

        .bar-container {
            background: rgba(0, 0, 0, 0.3);
            height: 20px;
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--noir-cyan), var(--noir-red));
            transition: width 0.5s ease;
        }

        .bar-label {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            color: white;
            text-shadow: 0 0 3px black;
        }

        /* Current step indicator */
        .step-indicator {
            text-align: center;
            padding: 10px;
            margin-top: 15px;
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid var(--noir-red);
            border-radius: 3px;
            color: var(--noir-red);
            font-size: 0.85rem;
        }

        /* Legend */
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
            padding: 10px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .legend-core { background: #ff6b6b; }
        .legend-tools { background: #4ecdc4; }
        .legend-content { background: #95e1d3; }
        .legend-specialized { background: #f38181; }

        /* Pulse animation for token */
        @keyframes pulse {
            0%, 100% { r: 6; opacity: 1; }
            50% { r: 10; opacity: 0.7; }
        }

        .flow-token.animating {
            animation: pulse 0.5s infinite;
        }

        /* Compact/mobile layout tweaks */
        @media (max-width: 640px) {
            body { padding-top: 56px; }
            h1 { font-size: 1.2rem; }
            .controls { gap: 8px; padding: 10px; }
            .controls select { width: 100%; }
            #flowDiagram { height: 320px; }
            .node-text { font-size: 9px; }
            .node-label { font-size: 8px; }
            .module-text { font-size: 7px; }
            .legend { gap: 8px; font-size: 0.7rem; }
            .panels { grid-template-columns: 1fr; gap: 12px; }
            .panel { padding: 10px; }
            /* keep details visible along with diagram */
            .module-details { max-height: 36vh; overflow: auto; }
        }

        /* Explicit compact mode toggle (also auto on small screens) */
        body.compact #flowDiagram { height: 320px; }
        body.compact .module-text { font-size: 7px; }
        body.compact .node-text { font-size: 9px; }
        body.compact .node-label { font-size: 8px; }
        body.compact .legend { gap: 8px; font-size: 0.7rem; }
        /* In compact mode, hide per-module micro-boxes for clarity */
        body.compact .modules-group .module-item { display: none; }
        body.compact .module-details { max-height: 36vh; overflow: auto; }
    </style>
</head>
<body>
    <a href="../index.html" class="home-link" aria-label="Back to home"></a>

    <div class="container">
        <h1>Modular Prompt Flow</h1>
        <p class="subtitle">Interactive visualization of Bot Sportello's prompt assembly system</p>

        <div class="controls">
            <label>Example Flow:</label>
            <select id="exampleSelect">
                <option value="greeting">Greeting Flow: "hey sportello"</option>
                <option value="edit">Edit Flow: "change the title in snake-game.html"</option>
                <option value="create">Build Flow: "build me a tetris game"</option>
                <option value="search">Search Flow: "what's the latest AI news"</option>
            </select>

            <button id="playBtn">Play</button>
            <button id="stepBtn">Step</button>
            <button id="resetBtn">Reset</button>
            <button id="compactBtn" title="Toggle compact layout">Compact</button>

            <div class="speed-control">
                <label>Speed:</label>
                <input type="range" id="speedSlider" min="200" max="2000" value="800" step="100">
            </div>
        </div>

        <div class="diagram-container">
            <svg id="flowDiagram" viewBox="0 0 900 450" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#555" />
                    </marker>
                    <marker id="arrowhead-active" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#ff0000" />
                    </marker>
                    <filter id="glow">
                        <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                        <feMerge>
                            <feMergeNode in="coloredBlur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>

                <!-- Row 1: Input -> Router -> Decision -->
                <!-- Input Node -->
                <g id="node-input" class="node" data-info="input">
                    <rect class="node-rect" x="30" y="30" width="100" height="50" rx="5"/>
                    <text class="node-text" x="80" y="52" text-anchor="middle">@mention</text>
                    <text class="node-label" x="80" y="68" text-anchor="middle">INPUT</text>
                </g>

                <!-- Edge: Input -> Router -->
                <path id="edge-input-router" class="edge" d="M130,55 L240,55"/>

                <!-- Router Node -->
                <g id="node-router" class="node" data-info="router" data-module="specialized/routing">
                    <rect class="node-rect" x="240" y="30" width="120" height="50" rx="5"/>
                    <text class="node-text" x="300" y="52" text-anchor="middle">Router</text>
                    <text class="node-label" x="300" y="68" text-anchor="middle">PATTERN MATCH</text>
                </g>

                <!-- Edge: Router -> Decision -->
                <path id="edge-router-decision" class="edge" d="M360,55 L460,55"/>

                <!-- Decision Node (Diamond) -->
                <g id="node-decision" class="node" data-info="decision">
                    <polygon class="decision-shape" points="520,20 580,55 520,90 460,55"/>
                    <text class="node-text" x="520" y="52" text-anchor="middle">Intent?</text>
                    <text class="node-label" x="520" y="68" text-anchor="middle">CLASSIFY</text>
                </g>

                <!-- Row 2: Three Paths (Chat, Full Agent, Pipeline) -->
                <!-- Edge: Decision -> Chat -->
                <path id="edge-decision-chat" class="edge" d="M490,90 L280,160"/>
                <text x="385" y="110" class="node-label" fill="#555">chat</text>

                <!-- Edge: Decision -> Full Agent -->
                <path id="edge-decision-full" class="edge" d="M520,90 L520,160"/>
                <text x="535" y="120" class="node-label" fill="#555">edit/read</text>

                <!-- Edge: Decision -> Pipeline -->
                <path id="edge-decision-pipeline" class="edge" d="M550,90 L760,160"/>
                <text x="655" y="110" class="node-label" fill="#555">create</text>

                <!-- Chat Assembler -->
                <g id="node-chat" class="node" data-info="chat">
                    <rect class="node-rect" x="210" y="160" width="140" height="50" rx="5"/>
                    <text class="node-text" x="280" y="182" text-anchor="middle">Chat</text>
                    <text class="node-label" x="280" y="198" text-anchor="middle">FAST PATH</text>
                </g>

                <!-- Full Agent Assembler -->
                <g id="node-full" class="node" data-info="full">
                    <rect class="node-rect" x="450" y="160" width="140" height="50" rx="5"/>
                    <text class="node-text" x="520" y="182" text-anchor="middle">Full Agent</text>
                    <text class="node-label" x="520" y="198" text-anchor="middle">TOOLS + CONTEXT</text>
                </g>

                <!-- Pipeline -->
                <g id="node-pipeline" class="node" data-info="pipeline">
                    <rect class="node-rect" x="690" y="160" width="140" height="50" rx="5"/>
                    <text class="node-text" x="760" y="182" text-anchor="middle">Pipeline</text>
                    <text class="node-label" x="760" y="198" text-anchor="middle">4-STAGE BUILD</text>
                </g>

                <!-- Row 3: Module Selection Areas -->
                <!-- Edge: Chat -> Chat Modules -->
                <path id="edge-chat-modules" class="edge" d="M280,210 L280,240"/>

                <!-- Edge: Full -> Full Modules -->
                <path id="edge-full-modules" class="edge" d="M520,210 L520,240"/>

                <!-- Edge: Pipeline -> Pipeline Stages -->
                <path id="edge-pipeline-stages" class="edge" d="M760,210 L760,240"/>

                <!-- Chat Modules Box -->
                <g id="modules-chat" class="modules-group" data-info="modules-chat">
                    <rect class="module-box" x="180" y="240" width="200" height="80" rx="3"/>
                    <text class="node-text" x="280" y="260" text-anchor="middle">Modules (3)</text>
                    <!-- Individual module boxes -->
                    <g class="module-item" data-module="core/identity">
                        <rect class="module-box" x="190" y="270" width="55" height="40" rx="2"/>
                        <text class="module-text" x="217" y="288" text-anchor="middle">identity</text>
                        <text class="module-text" x="217" y="300" text-anchor="middle">~200 tok</text>
                    </g>
                    <g class="module-item" data-module="core/repository">
                        <rect class="module-box" x="252" y="270" width="55" height="40" rx="2"/>
                        <text class="module-text" x="279" y="288" text-anchor="middle">repository</text>
                        <text class="module-text" x="279" y="300" text-anchor="middle">~250 tok</text>
                    </g>
                    <g class="module-item" data-module="core/capabilities">
                        <rect class="module-box" x="314" y="270" width="55" height="40" rx="2"/>
                        <text class="module-text" x="341" y="288" text-anchor="middle">capabilities</text>
                        <text class="module-text" x="341" y="300" text-anchor="middle">~200 tok</text>
                    </g>
                </g>

                <!-- Full Agent Modules Box -->
                <g id="modules-full" class="modules-group" data-info="modules-full">
                    <rect class="module-box" x="400" y="240" width="240" height="110" rx="3"/>
                    <text class="node-text" x="520" y="260" text-anchor="middle">Modules (8)</text>
                    <!-- Row 1 (left to right) -->
                    <g class="module-item" data-module="core/explorationRules">
                        <rect class="module-box" x="405" y="270" width="50" height="30" rx="2"/>
                        <text class="module-text" x="430" y="288" text-anchor="middle">explore</text>
                    </g>
                    <g class="module-item" data-module="core/contextRules">
                        <rect class="module-box" x="460" y="270" width="50" height="30" rx="2"/>
                        <text class="module-text" x="485" y="288" text-anchor="middle">context</text>
                    </g>
                    <g class="module-item" data-module="core/identity">
                        <rect class="module-box" x="515" y="270" width="50" height="30" rx="2"/>
                        <text class="module-text" x="540" y="288" text-anchor="middle">identity</text>
                    </g>
                    <g class="module-item" data-module="core/repository">
                        <rect class="module-box" x="570" y="270" width="50" height="30" rx="2"/>
                        <text class="module-text" x="595" y="288" text-anchor="middle">repo</text>
                    </g>
                    <!-- Row 2 (left to right) -->
                    <g class="module-item" data-module="core/capabilities">
                        <rect class="module-box" x="405" y="310" width="50" height="30" rx="2"/>
                        <text class="module-text" x="430" y="328" text-anchor="middle">caps</text>
                    </g>
                    <g class="module-item" data-module="tools/fileOperations">
                        <rect class="module-box" x="460" y="310" width="50" height="30" rx="2"/>
                        <text class="module-text" x="485" y="328" text-anchor="middle">file</text>
                    </g>
                    <g class="module-item" data-module="tools/gitOperations">
                        <rect class="module-box" x="515" y="310" width="50" height="30" rx="2"/>
                        <text class="module-text" x="540" y="328" text-anchor="middle">git</text>
                    </g>
                    <g class="module-item" data-module="tools/searchGuidelines">
                        <rect class="module-box" x="570" y="310" width="50" height="30" rx="2"/>
                        <text class="module-text" x="595" y="328" text-anchor="middle">search</text>
                    </g>
                </g>

                <!-- Pipeline Stages Box -->
                <g id="stages-pipeline" class="modules-group" data-info="stages-pipeline">
                    <rect class="module-box" x="680" y="240" width="160" height="80" rx="3"/>
                    <text class="node-text" x="760" y="260" text-anchor="middle">4 Stages</text>
                    <!-- Stage boxes -->
                    <g class="module-item" data-module="architect">
                        <rect class="module-box" x="685" y="270" width="35" height="40" rx="2"/>
                        <text class="module-text" x="702" y="288" text-anchor="middle">Arch</text>
                        <text class="module-text" x="702" y="300" text-anchor="middle">~100</text>
                    </g>
                    <g class="module-item" data-module="builder">
                        <rect class="module-box" x="725" y="270" width="35" height="40" rx="2"/>
                        <text class="module-text" x="742" y="288" text-anchor="middle">Build</text>
                        <text class="module-text" x="742" y="300" text-anchor="middle">~400</text>
                    </g>
                    <g class="module-item" data-module="tester">
                        <rect class="module-box" x="765" y="270" width="35" height="40" rx="2"/>
                        <text class="module-text" x="782" y="288" text-anchor="middle">Test</text>
                        <text class="module-text" x="782" y="300" text-anchor="middle">~150</text>
                    </g>
                    <g class="module-item" data-module="scribe">
                        <rect class="module-box" x="805" y="270" width="30" height="40" rx="2"/>
                        <text class="module-text" x="820" y="288" text-anchor="middle">Scr</text>
                        <text class="module-text" x="820" y="300" text-anchor="middle">~60</text>
                    </g>
                </g>

                <!-- Row 4: Output Nodes -->
                <!-- Edge: Chat Modules -> Chat Output -->
                <path id="edge-chatmod-output" class="edge" d="M280,320 L280,360"/>

                <!-- Edge: Full Modules -> Full Output -->
                <path id="edge-fullmod-output" class="edge" d="M520,350 L520,360"/>

                <!-- Edge: Pipeline Stages -> Pipeline Output -->
                <path id="edge-pipemod-output" class="edge" d="M760,320 L760,360"/>

                <!-- Chat Output -->
                <g id="node-chat-output" class="node" data-info="output-chat">
                    <rect class="node-rect" x="210" y="360" width="140" height="50" rx="5"/>
                    <text class="node-text" x="280" y="380" text-anchor="middle">Final Prompt</text>
                    <text class="node-label" x="280" y="398" text-anchor="middle">~650 tokens</text>
                </g>

                <!-- Full Output -->
                <g id="node-full-output" class="node" data-info="output-full">
                    <rect class="node-rect" x="450" y="360" width="140" height="50" rx="5"/>
                    <text class="node-text" x="520" y="380" text-anchor="middle">Final Prompt</text>
                    <text class="node-label" x="520" y="398" text-anchor="middle">~1400 tokens</text>
                </g>

                <!-- Pipeline Output -->
                <g id="node-pipeline-output" class="node" data-info="output-pipeline">
                    <rect class="node-rect" x="690" y="360" width="140" height="50" rx="5"/>
                    <text class="node-text" x="760" y="380" text-anchor="middle">4 Prompts</text>
                    <text class="node-label" x="760" y="398" text-anchor="middle">~710 total tokens</text>
                </g>

                <!-- Savings Annotations -->
                <text x="280" y="430" class="node-label" text-anchor="middle" fill="#00ff00">72% savings vs mono</text>
                <text x="520" y="430" class="node-label" text-anchor="middle" fill="#00ff00">46% savings vs mono</text>
                <text x="760" y="430" class="node-label" text-anchor="middle" fill="#00ff00">Per-stage efficiency</text>

                <!-- Flow Token (animated) -->
                <circle id="flowToken" class="flow-token" cx="80" cy="55" r="8"/>
            </svg>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="legend-color legend-core"></div><span>core/</span></div>
            <div class="legend-item"><div class="legend-color legend-tools"></div><span>tools/</span></div>
            <div class="legend-item"><div class="legend-color legend-content"></div><span>content/</span></div>
            <div class="legend-item"><div class="legend-color legend-specialized"></div><span>specialized/</span></div>
        </div>

        <div class="panels">
            <div class="panel module-details">
                <h3>Module Details</h3>
                <div id="moduleInfo">
                    <p class="placeholder">Click on any module or node to see details</p>
                </div>
            </div>

            <div class="panel">
                <h3>Flow Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="statModules">-</div>
                        <div class="stat-label">Modules</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statTokens">-</div>
                        <div class="stat-label">Tokens</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="statSavings">-</div>
                        <div class="stat-label">Savings</div>
                    </div>
                </div>

                <div class="savings-bar">
                    <h4>Token Usage vs Monolithic (1500 tok)</h4>
                    <div class="bar-container">
                        <div class="bar-fill" id="savingsBar" style="width: 0%"></div>
                        <span class="bar-label" id="barLabel">-</span>
                    </div>
                </div>

                <div class="step-indicator" id="stepIndicator">
                    Select an example and click Play to start
                </div>
            </div>
        </div>
    </div>

    <script>
        // Module data with actual content previews
        const MODULES = {
            'specialized/routing': {
                name: 'routing',
                category: 'specialized',
                lines: 44,
                tokens: 0,
                purpose: 'Instant pattern-based intent classification (no LLM call)',
                preview: `Pattern-based routing using regex patterns:
- Structural transforms: /follow|match|same design/ → write_file
- Edit requests: /edit|change|fix/ + path → edit_file
- Create requests: /create|build|make/ → pipeline
- Pronouns: "fix it" + recent file → resolve from cache
No API call - instant classification (<1ms)`
            },
            'core/identity': {
                name: 'identity',
                category: 'core',
                lines: 35,
                tokens: 200,
                purpose: 'Doc Sportello personality, voice, and response formatting',
                preview: `You are Bot Sportello, a laid-back Discord bot who helps people with web development projects. You're helpful but a little spacey, like Doc Sportello - generally competent but sometimes distracted, speaking in a relaxed, slightly rambling way.

Personality: Casual, chill, slightly unfocused but helpful. SHORT responses (1-2 sentences). Use "yeah man", "right on".`
            },
            'core/repository': {
                name: 'repository',
                category: 'core',
                lines: 56,
                tokens: 280,
                purpose: 'URLs, file paths, inventory location, project metadata',
                preview: `AUTHORITATIVE SOURCES (Check these FIRST):
- src/site-inventory.html is THE SOURCE OF TRUTH for current site structure
  * Contains complete diagrams of all webpages and JavaScript files
  * Use read_file("src/site-inventory.html") as your FIRST step when uncertain...`
            },
            'core/capabilities': {
                name: 'capabilities',
                category: 'core',
                lines: 44,
                tokens: 220,
                purpose: 'High-level overview of available tools and when to use them',
                preview: `AVAILABLE CAPABILITIES (Enhanced Multi-File Support):
- file_exists(path|url): FAST existence check - use FIRST when given a URL
- list_files(path|[paths]): List files in directory
- search_files(pattern, path|[paths]): Search text patterns across files
- read_file(path|[paths]): Read single or multiple files...`
            },
            'core/explorationRules': {
                name: 'explorationRules',
                category: 'core',
                lines: 40,
                tokens: 180,
                purpose: 'Decisive action rules - act fast, ask when truly stuck',
                preview: `DECISION RULES (Be confident, act fast):

1. ACT DECISIVELY when you have clear signals:
   - User gives filename? → file_exists → read_file → act
   - Clear request? → do it, don't ask permission

2. ASK QUESTIONS when truly ambiguous:
   - Multiple files could match → ask user
   - Vague request with no context → ask for specifics...`
            },
            'core/contextRules': {
                name: 'contextRules',
                category: 'core',
                lines: 54,
                tokens: 220,
                purpose: 'Reference resolution for pronouns like "the game" or "it"',
                preview: `REFERENCE RESOLUTION (Use action cache and context):

WHEN USER SAYS "THE GAME", "THE PAGE", "IT", "THAT FILE":
1. Check [RECENT BOT ACTIONS] context FIRST
   - Look for recently created/edited files in action summary
   - Example: "[RECENT BOT ACTIONS] - EDIT: src/maze-game.html"...`
            },
            'tools/fileOperations': {
                name: 'fileOperations',
                category: 'tools',
                lines: 57,
                tokens: 280,
                purpose: 'Detailed guidelines for when and how to use each file tool',
                preview: `NEVER HALLUCINATE - ALWAYS VERIFY:
- Never assume what's in a file - read it first
- Never assume a file exists - check with file_exists or list_files
- Never make up filenames - use search_files to find real files
- When unsure, explore first (list_files -> file_exists -> read_file)...`
            },
            'tools/gitOperations': {
                name: 'gitOperations',
                category: 'tools',
                lines: 31,
                tokens: 120,
                purpose: 'Git commit, status, and log operations',
                preview: `GIT OPERATIONS:
- commit_changes(message, files): Git add, commit, push to main branch
  * Automatically pushes to GitHub and triggers deployment
  * Commit messages should be lowercase, detailed but max 100 chars

- get_repo_status(): Check current git status and branch info...`
            },
            'tools/searchGuidelines': {
                name: 'searchGuidelines',
                category: 'tools',
                lines: 32,
                tokens: 130,
                purpose: 'When to use web_search vs deep_research',
                preview: `WHEN TO USE WEB SEARCH:
- Anything that changes: sports, news, prices, weather, standings
- Questions with "latest", "current", "today", "now"
- When you don't have up-to-date info, just search
- Always include sources with links in your response...`
            },
            'architect': {
                name: 'architect',
                category: 'pipeline',
                lines: 50,
                tokens: 100,
                purpose: 'Content pipeline: Classify type, generate implementation plan',
                preview: `Architect for Bot Sportello noir web collection.

TASK: Classify content type, return JSON plan with:
- contentType (game, utility, visualization, story)
- interactionPattern (directional-movement, direct-touch, hybrid)
- Key features and technical requirements...`
            },
            'builder': {
                name: 'builder',
                category: 'pipeline',
                lines: 120,
                tokens: 400,
                purpose: 'Content pipeline: Generate HTML/CSS/JS from architect plan',
                preview: `Builder for Bot Sportello noir web collection.

TASK: Generate complete, working HTML page based on architect plan.

CRITICAL REQUIREMENTS:
- Link to ../page-theme.css (noir terminal theme)
- Mobile-first with touch controls (44px targets)
- Match interaction pattern from plan exactly...`
            },
            'tester': {
                name: 'tester',
                category: 'pipeline',
                lines: 60,
                tokens: 150,
                purpose: 'Content pipeline: Validate output with automated checks',
                preview: `Tester for Bot Sportello content pipeline.

TASK: Validate generated HTML for:
1. Required elements (viewport meta, page-theme.css link)
2. Mobile compatibility (touch handlers, no hover-only)
3. Interaction pattern compliance (D-pad vs direct touch)
4. Return score 0-100 with specific issues...`
            },
            'scribe': {
                name: 'scribe',
                category: 'pipeline',
                lines: 30,
                tokens: 60,
                purpose: 'Content pipeline: Generate metadata and release notes',
                preview: `Scribe for Bot Sportello content pipeline.

TASK: Generate project metadata in Doc Sportello's voice:
- title: Short descriptive name
- icon: Single emoji
- caption: 3-6 word description
- releaseNotes: 2-3 sentences, casual tone...`
            }
        };

        // Assembler configurations
        const ASSEMBLERS = {
            router: {
                name: 'Pattern Router',
                modules: ['specialized/routing'],
                totalTokens: 0,
                usedFor: 'Instant intent classification (regex patterns, no LLM)'
            },
            chat: {
                name: 'Chat Path',
                modules: ['core/identity', 'core/repository', 'core/capabilities'],
                totalTokens: 700,
                usedFor: 'Greeting/conversation fast path (kimi-fast)'
            },
            full: {
                name: 'Full Agent',
                modules: ['core/explorationRules', 'core/contextRules', 'core/identity', 'core/repository', 'core/capabilities', 'tools/fileOperations', 'tools/gitOperations', 'tools/searchGuidelines'],
                totalTokens: 1430,
                usedFor: 'Tool execution with context (DeepSeek V3.1)'
            },
            pipeline: {
                name: 'Content Pipeline',
                stages: ['architect', 'builder', 'tester', 'scribe'],
                totalTokens: 710,
                usedFor: 'Multi-stage content creation'
            }
        };

        // Example flow definitions
        const EXAMPLES = {
            greeting: {
                name: 'Greeting Flow',
                input: '"hey sportello"',
                description: 'Pure greeting triggers chat fast path - minimal token usage',
                steps: [
                    { node: 'node-input', edge: 'edge-input-router', label: 'User sends @mention' },
                    { node: 'node-router', edge: 'edge-router-decision', label: 'Pattern: no file ref, short msg → intent=chat (<1ms)' },
                    { node: 'node-decision', edge: 'edge-decision-chat', label: 'Decision: Chat fast path' },
                    { node: 'node-chat', edge: 'edge-chat-modules', label: 'assembleChat() called' },
                    { node: 'modules-chat', edge: 'edge-chatmod-output', label: 'Load 3 modules: identity + repository + capabilities' },
                    { node: 'node-chat-output', label: 'Final prompt: ~650 tokens (72% savings)' }
                ],
                assembler: 'chat',
                savings: 72
            },
            edit: {
                name: 'Edit File Flow',
                input: '"change the title in snake-game.html"',
                description: 'Edit intent routes to full agent with all tools available',
                steps: [
                    { node: 'node-input', edge: 'edge-input-router', label: 'User sends edit request' },
                    { node: 'node-router', edge: 'edge-router-decision', label: 'Pattern: /change/ + .html → intent=edit, path=src/snake-game.html (<1ms)' },
                    { node: 'node-decision', edge: 'edge-decision-full', label: 'Decision: Full agent with tools' },
                    { node: 'node-full', edge: 'edge-full-modules', label: 'assembleFullAgent() + routing guidance hints' },
                    { node: 'modules-full', edge: 'edge-fullmod-output', label: 'Load 8 modules with decisive action rules' },
                    { node: 'node-full-output', label: 'Final prompt: ~1400 tokens (46% savings)' }
                ],
                assembler: 'full',
                savings: 46
            },
            create: {
                name: 'Game Build Flow',
                input: '"build me a tetris game"',
                description: 'Content creation uses 4-stage pipeline with specialized prompts',
                steps: [
                    { node: 'node-input', edge: 'edge-input-router', label: 'User sends build request' },
                    { node: 'node-router', edge: 'edge-router-decision', label: 'Pattern: /build|create|make/ → intent=create (<1ms)' },
                    { node: 'node-decision', edge: 'edge-decision-pipeline', label: 'Decision: Content pipeline' },
                    { node: 'node-pipeline', edge: 'edge-pipeline-stages', label: 'runGamePipeline() initiated' },
                    { node: 'stages-pipeline', edge: 'edge-pipemod-output', label: 'Stage 1: Architect (100 tok) -> Stage 2: Builder (400 tok) -> Stage 3: Tester (150 tok) -> Stage 4: Scribe (60 tok)' },
                    { node: 'node-pipeline-output', label: 'Total: ~710 tokens across 4 specialized prompts' }
                ],
                assembler: 'pipeline',
                savings: 53
            },
            search: {
                name: 'Web Search Flow',
                input: '"what\'s the latest AI news"',
                description: 'Search intent uses full agent with web_search tool prioritized',
                steps: [
                    { node: 'node-input', edge: 'edge-input-router', label: 'User asks about current events' },
                    { node: 'node-router', edge: 'edge-router-decision', label: 'Pattern: /latest|current|news/ → intent=search (<1ms)' },
                    { node: 'node-decision', edge: 'edge-decision-full', label: 'Decision: Full agent (search needs tools)' },
                    { node: 'node-full', edge: 'edge-full-modules', label: 'assembleFullAgent() with searchGuidelines' },
                    { node: 'modules-full', edge: 'edge-fullmod-output', label: 'Load 8 modules including search guidelines' },
                    { node: 'node-full-output', label: 'Final prompt: ~1400 tokens + web_search tool' }
                ],
                assembler: 'full',
                savings: 46
            }
        };

        // Animation state
        let currentExample = 'greeting';
        let currentStep = 0;
        let isPlaying = false;
        let animationInterval = null;
        let animationSpeed = 800;

        // DOM elements
        const exampleSelect = document.getElementById('exampleSelect');
        const playBtn = document.getElementById('playBtn');
        const stepBtn = document.getElementById('stepBtn');
        const resetBtn = document.getElementById('resetBtn');
        const speedSlider = document.getElementById('speedSlider');
        const moduleInfo = document.getElementById('moduleInfo');
        const flowToken = document.getElementById('flowToken');
        const stepIndicator = document.getElementById('stepIndicator');
        const compactBtn = document.getElementById('compactBtn');

        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // Initialize
        function init() {
            exampleSelect.addEventListener('change', handleExampleChange);
            playBtn.addEventListener('click', togglePlay);
            stepBtn.addEventListener('click', stepForward);
            resetBtn.addEventListener('click', resetAnimation);
            speedSlider.addEventListener('input', (e) => {
                animationSpeed = 2200 - parseInt(e.target.value);
            });

            // Compact mode toggle + auto-enable on small screens
            compactBtn.addEventListener('click', () => {
                document.body.classList.toggle('compact');
                compactBtn.classList.toggle('active');
            });
            // Allow overriding compact breakpoint via ?compactBP=### or ?bp=### and persist in localStorage
            const qpBP = parseInt(getQueryParam('compactBP') || getQueryParam('bp'), 10);
            if (!Number.isNaN(qpBP)) {
                try { localStorage.setItem('compactBP', String(qpBP)); } catch (e) {}
            }
            const storedBP = parseInt((() => { try { return localStorage.getItem('compactBP'); } catch (e) { return null; } })() || '640', 10);
            const compactQuery = `(max-width: ${storedBP}px)`;
            document.body.setAttribute('data-compact-bp', String(storedBP));
            if (window.matchMedia && window.matchMedia(compactQuery).matches) {
                document.body.classList.add('compact');
                compactBtn.classList.add('active');
            }

            // Click handlers for modules
            document.querySelectorAll('.module-item').forEach(el => {
                el.addEventListener('click', () => showModuleDetails(el.dataset.module));
            });

            // Allow clicking entire module groups in compact layout
            document.querySelectorAll('.modules-group').forEach(el => {
                el.addEventListener('click', () => showNodeInfo(el.dataset.info));
            });

            document.querySelectorAll('.node').forEach(el => {
                el.addEventListener('click', () => showNodeInfo(el.dataset.info, el.dataset.module));
            });

            updateStats(currentExample);
        }

        function handleExampleChange() {
            resetAnimation();
            currentExample = exampleSelect.value;
            updateStats(currentExample);
            highlightPath(currentExample);
        }

        function togglePlay() {
            if (isPlaying) {
                pauseAnimation();
            } else {
                playAnimation();
            }
        }

        function playAnimation() {
            isPlaying = true;
            playBtn.textContent = 'Pause';
            playBtn.classList.add('active');

            animationInterval = setInterval(() => {
                if (currentStep < EXAMPLES[currentExample].steps.length) {
                    animateStep(currentStep);
                    currentStep++;
                } else {
                    pauseAnimation();
                }
            }, animationSpeed);
        }

        function pauseAnimation() {
            isPlaying = false;
            playBtn.textContent = 'Play';
            playBtn.classList.remove('active');
            clearInterval(animationInterval);
        }

        function stepForward() {
            if (currentStep < EXAMPLES[currentExample].steps.length) {
                animateStep(currentStep);
                currentStep++;
            }
        }

        function resetAnimation() {
            pauseAnimation();
            currentStep = 0;

            // Clear all active states
            document.querySelectorAll('.node-rect, .decision-shape').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.edge').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.module-box').forEach(el => {
                el.classList.remove('highlighted');
            });

            flowToken.classList.remove('visible', 'animating');
            stepIndicator.textContent = 'Select an example and click Play to start';
        }

        function animateStep(stepIndex) {
            const example = EXAMPLES[currentExample];
            const step = example.steps[stepIndex];

            // Highlight current node
            const node = document.getElementById(step.node);
            if (node) {
                const rect = node.querySelector('.node-rect, .decision-shape, .module-box');
                if (rect) {
                    rect.classList.add('active');
                }

                // Move token to node
                const bbox = node.getBBox ? node.getBBox() : { x: 0, y: 0, width: 100, height: 50 };
                flowToken.setAttribute('cx', bbox.x + bbox.width / 2);
                flowToken.setAttribute('cy', bbox.y + bbox.height / 2);
                flowToken.classList.add('visible', 'animating');
            }

            // Highlight edge (if exists)
            if (step.edge) {
                const edge = document.getElementById(step.edge);
                if (edge) {
                    edge.classList.add('active');
                    edge.setAttribute('marker-end', 'url(#arrowhead-active)');
                }
            }

            // Highlight modules for module groups
            if (step.node.startsWith('modules-')) {
                const group = document.getElementById(step.node);
                if (group) {
                    group.querySelectorAll('.module-box').forEach(box => {
                        box.classList.add('highlighted');
                    });
                }
            }

            // Update step indicator
            stepIndicator.innerHTML = `<strong>Step ${stepIndex + 1}/${example.steps.length}:</strong> ${step.label}`;
        }

        function highlightPath(exampleKey) {
            // Dim non-relevant paths
            const example = EXAMPLES[exampleKey];
            const relevantNodes = example.steps.map(s => s.node);

            document.querySelectorAll('.node').forEach(node => {
                if (!relevantNodes.includes(node.id)) {
                    node.style.opacity = '0.4';
                } else {
                    node.style.opacity = '1';
                }
            });
        }

        function showModuleDetails(moduleKey) {
            const mod = MODULES[moduleKey];
            if (!mod) {
                moduleInfo.innerHTML = '<p class="placeholder">Module not found</p>';
                return;
            }

            const categoryColors = {
                core: '#ff6b6b',
                tools: '#4ecdc4',
                content: '#95e1d3',
                specialized: '#f38181',
                pipeline: '#ffd93d'
            };

            moduleInfo.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Name:</span>
                    <span class="detail-value">${mod.name}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Category:</span>
                    <span class="detail-value" style="color: ${categoryColors[mod.category]}">${mod.category}/</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Lines:</span>
                    <span class="detail-value">${mod.lines}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tokens:</span>
                    <span class="detail-value">~${mod.tokens}</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Purpose:</span>
                    <span class="detail-value">${mod.purpose}</span>
                </div>
                <div class="preview-box">${escapeHtml(mod.preview)}</div>
            `;

            // Keep details visible with the diagram on small screens
            try {
                const storedBP = parseInt(localStorage.getItem('compactBP') || '640', 10);
                const compactQuery = `(max-width: ${storedBP}px)`;
                if (window.matchMedia && window.matchMedia(compactQuery).matches) {
                    document.querySelector('.module-details').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            } catch (e) {}
        }

        function showNodeInfo(infoKey, moduleKey) {
            if (moduleKey) {
                showModuleDetails(moduleKey);
                return;
            }

            const nodeDescriptions = {
                'input': { name: '@mention Input', desc: 'User mentions Bot Sportello in Discord. Message content is extracted and passed to routing system.' },
                'router': { name: 'Pattern Router', desc: 'Instant regex-based classification (<1ms). Extracts file paths, detects structural transformations, resolves pronouns from action cache. No LLM call - pure pattern matching.' },
                'decision': { name: 'Intent Decision', desc: 'Based on pattern router output, determines which path: chat (greeting), full agent (tools), or pipeline (content creation). Routing guidance passed to main LLM.' },
                'chat': { name: 'assembleChat()', desc: 'Minimal prompt assembly for pure greetings. Only loads identity, repository, and capabilities modules. Uses kimi-fast model for quick responses.' },
                'full': { name: 'assembleFullAgent()', desc: 'Complete prompt with anti-hallucination rules, all tool guidelines, and context resolution. Used for file operations, edits, and searches.' },
                'pipeline': { name: 'Content Pipeline', desc: '4-stage build process: Architect (plan) -> Builder (generate) -> Tester (validate) -> Scribe (metadata). Each stage has specialized prompt.' },
                'modules-chat': { name: 'Chat Modules', desc: '3 modules: identity (personality), repository (URLs/paths), capabilities (tool overview). Minimal but sufficient for conversation.' },
                'modules-full': { name: 'Full Agent Modules', desc: '8 modules including anti-hallucination rules, context resolution, file ops, git ops, and search guidelines. Comprehensive tool execution context.' },
                'stages-pipeline': { name: 'Pipeline Stages', desc: 'Architect (~100 tok), Builder (~400 tok), Tester (~150 tok), Scribe (~60 tok). Each stage runs sequentially with specialized prompt.' },
                'output-chat': { name: 'Chat Output', desc: 'Final assembled prompt ~650 tokens. 72% smaller than monolithic prompt. Fast response time with kimi-fast model.' },
                'output-full': { name: 'Full Agent Output', desc: 'Final assembled prompt ~1400 tokens. 46% smaller than if content modules were included. Includes routing guidance from router.' },
                'output-pipeline': { name: 'Pipeline Output', desc: 'Four separate prompts totaling ~710 tokens. Per-stage efficiency - each stage only loads what it needs.' }
            };

            const info = nodeDescriptions[infoKey];
            if (info) {
                moduleInfo.innerHTML = `
                    <div class="detail-row">
                        <span class="detail-label">Node:</span>
                        <span class="detail-value">${info.name}</span>
                    </div>
                    <div class="preview-box" style="max-height: 150px;">${info.desc}</div>
                `;
                try {
                    const storedBP = parseInt(localStorage.getItem('compactBP') || '640', 10);
                    const compactQuery = `(max-width: ${storedBP}px)`;
                    if (window.matchMedia && window.matchMedia(compactQuery).matches) {
                        document.querySelector('.module-details').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                } catch (e) {}
            }
        }

        function updateStats(exampleKey) {
            const example = EXAMPLES[exampleKey];
            const assembler = ASSEMBLERS[example.assembler];

            let moduleCount, tokenCount;
            if (example.assembler === 'pipeline') {
                moduleCount = 4;
                tokenCount = assembler.totalTokens;
            } else {
                moduleCount = assembler.modules.length;
                tokenCount = assembler.totalTokens;
            }

            document.getElementById('statModules').textContent = moduleCount;
            document.getElementById('statTokens').textContent = tokenCount;
            document.getElementById('statSavings').textContent = example.savings + '%';

            // Update savings bar (percentage of monolithic 1500 tokens)
            const usagePercent = Math.round((tokenCount / 1500) * 100);
            document.getElementById('savingsBar').style.width = usagePercent + '%';
            document.getElementById('barLabel').textContent = tokenCount + ' / 1500';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Start
        init();
    </script>
</body>
</html>
