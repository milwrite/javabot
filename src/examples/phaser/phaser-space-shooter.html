<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../../../page-theme.css">
    <title>Phaser Space Shooter</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.1/dist/phaser.min.js"></script>
</head>
<body>
    <a href="../../../index.html" class="home-link"></a>

    <div class="container">
        <h1>Space Shooter</h1>
        <p class="subtitle">Arrow keys or D-pad controls</p>

        <div class="game-wrapper">
            <div class="stats-bar">
                <div class="stat">
                    <span class="stat-label">Score</span>
                    <span class="stat-value" id="score">0</span>
                </div>
                <div class="stat">
                    <span class="stat-label">Lives</span>
                    <span class="stat-value" id="lives">3</span>
                </div>
            </div>

            <div id="phaser-container"></div>

            <!-- Hybrid controls: D-pad movement + shoot button -->
            <div class="mobile-controls">
                <div class="control-btn empty"></div>
                <button class="control-btn" id="btnUp" aria-label="Move up">↑</button>
                <div class="control-btn empty"></div>
                <button class="control-btn" id="btnLeft" aria-label="Move left">←</button>
                <button class="control-btn" id="btnDown" aria-label="Move down">↓</button>
                <button class="control-btn" id="btnRight" aria-label="Move right">→</button>
            </div>

            <div class="control-actions">
                <button class="btn btn-primary" id="btnShoot" aria-label="Fire weapon">FIRE</button>
            </div>

            <div id="restart-container" class="restart-container" style="display: none;">
                <button class="btn btn-primary" id="btnRestart" aria-label="Restart game">RESTART</button>
            </div>
        </div>
    </div>

    <script>
        // Noir color palette (Phaser format)
        const CYAN_BLUE = 0x7ec8e3;
        const RED = 0xff0000;
        const CYAN = 0x00ffff;
        const WHITE = 0xffffff;

        // Game constants
        const PLAYER_SPEED = 200;
        const BULLET_SPEED = 400;
        const FIRE_RATE = 300;
        const ENEMY_SPAWN_DELAY = 1500;
        const ENEMY_MIN_SPEED = 80;
        const ENEMY_MAX_SPEED = 150;

        // Game state
        let score = 0;
        let lives = 3;
        let gameOver = false;
        let player, enemies, bullets;
        let cursors, shootKey;
        let lastFired = 0;
        let mobileFirePressed = false;
        let enemySpawnTimer;

        // Phaser config with noir theme integration
        const config = {
            type: Phaser.AUTO,
            parent: 'phaser-container',
            transparent: true,  // CRITICAL: Shows page-theme.css background
            width: 400,
            height: 500,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.NO_CENTER
            },
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { y: 0 },
                    debug: false
                }
            },
            scene: {
                create: create,
                update: update
            }
        };

        const game = new Phaser.Game(config);

        function create() {
            // Create player ship
            player = this.add.rectangle(200, 450, 20, 20, CYAN);
            this.physics.add.existing(player);
            player.body.setCollideWorldBounds(true);

            // Create groups
            enemies = this.physics.add.group();
            bullets = this.physics.add.group();

            // Keyboard input
            cursors = this.input.keyboard.createCursorKeys();
            shootKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

            // Collisions
            this.physics.add.overlap(bullets, enemies, hitEnemy, null, this);
            this.physics.add.overlap(player, enemies, hitPlayer, null, this);

            // Spawn enemies periodically
            enemySpawnTimer = this.time.addEvent({
                delay: ENEMY_SPAWN_DELAY,
                callback: spawnEnemy,
                callbackScope: this,
                loop: true
            });

            // Wire mobile controls
            setupMobileControls(this);

            // Instructions
            this.add.text(200, 30, 'DESTROY THE INVADERS', {
                fontFamily: 'Courier Prime',
                fontSize: '16px',
                color: '#7ec8e3',
                stroke: '#000000',
                strokeThickness: 2
            }).setOrigin(0.5);
        }

        function update(time) {
            if (gameOver) return;

            // Player movement
            if (cursors.left.isDown) {
                player.setVelocityX(-PLAYER_SPEED);
            } else if (cursors.right.isDown) {
                player.setVelocityX(PLAYER_SPEED);
            } else {
                player.setVelocityX(0);
            }

            if (cursors.up.isDown) {
                player.setVelocityY(-PLAYER_SPEED);
            } else if (cursors.down.isDown) {
                player.setVelocityY(PLAYER_SPEED);
            } else {
                player.setVelocityY(0);
            }

            // Shooting
            if ((shootKey.isDown || mobileFirePressed) && time > lastFired + FIRE_RATE) {
                shoot(this);
                lastFired = time;
            }

            // Remove off-screen bullets
            bullets.children.entries.forEach(bullet => {
                if (bullet.y < -10) {
                    bullet.destroy();
                }
            });

            // Remove off-screen enemies
            enemies.children.entries.forEach(enemy => {
                if (enemy.y > 510) {
                    enemy.destroy();
                }
            });
        }

        function shoot(scene) {
            const bullet = scene.add.rectangle(player.x, player.y - 15, 4, 12, CYAN);
            scene.physics.add.existing(bullet);
            bullet.body.setVelocityY(-BULLET_SPEED);
            bullets.add(bullet);
        }

        function spawnEnemy() {
            if (gameOver) return;

            const x = Phaser.Math.Between(20, 380);
            const enemy = this.add.rectangle(x, -20, 20, 20, RED);
            this.physics.add.existing(enemy);
            enemy.body.setVelocityY(Phaser.Math.Between(ENEMY_MIN_SPEED, ENEMY_MAX_SPEED));
            enemies.add(enemy);
        }

        function hitEnemy(bullet, enemy) {
            bullet.destroy();
            enemy.destroy();
            score += 10;
            updateScore();
        }

        function hitPlayer(player, enemy) {
            enemy.destroy();
            lives--;
            updateLives();

            if (lives <= 0) {
                endGame.call(this);
            }
        }

        function endGame() {
            gameOver = true;
            enemySpawnTimer.remove();

            // Flash player red
            player.setTint(RED);

            // Show game over text
            const gameOverText = this.add.text(200, 250, 'GAME OVER', {
                fontFamily: 'Courier Prime',
                fontSize: '32px',
                color: '#ff0000',
                stroke: '#000000',
                strokeThickness: 3
            }).setOrigin(0.5);

            const finalScore = this.add.text(200, 290, `FINAL SCORE: ${score}`, {
                fontFamily: 'Courier Prime',
                fontSize: '16px',
                color: '#7ec8e3',
                stroke: '#000000',
                strokeThickness: 2
            }).setOrigin(0.5);

            // Show restart button
            document.getElementById('restart-container').style.display = 'block';
        }

        function wireDirectionalButton(button, cursorKey) {
            ['touchstart', 'mousedown'].forEach(eventType => {
                button.addEventListener(eventType, (e) => {
                    e.preventDefault();
                    cursorKey.isDown = true;
                }, { passive: false });
            });

            ['touchend', 'mouseup', 'touchcancel'].forEach(eventType => {
                button.addEventListener(eventType, (e) => {
                    e.preventDefault();
                    cursorKey.isDown = false;
                }, { passive: false });
            });
        }

        function setupMobileControls(scene) {
            const btnUp = document.getElementById('btnUp');
            const btnDown = document.getElementById('btnDown');
            const btnLeft = document.getElementById('btnLeft');
            const btnRight = document.getElementById('btnRight');
            const btnShoot = document.getElementById('btnShoot');
            const btnRestart = document.getElementById('btnRestart');

            if (!btnUp) return;

            // Wire restart button
            if (btnRestart) {
                btnRestart.addEventListener('click', () => location.reload());
            }

            // Wire D-pad buttons
            wireDirectionalButton(btnUp, cursors.up);
            wireDirectionalButton(btnDown, cursors.down);
            wireDirectionalButton(btnLeft, cursors.left);
            wireDirectionalButton(btnRight, cursors.right);

            // Shoot button (continuous press)
            ['touchstart', 'mousedown'].forEach(eventType => {
                btnShoot.addEventListener(eventType, (e) => {
                    e.preventDefault();
                    mobileFirePressed = true;
                }, { passive: false });
            });

            ['touchend', 'mouseup', 'touchcancel'].forEach(eventType => {
                btnShoot.addEventListener(eventType, (e) => {
                    e.preventDefault();
                    mobileFirePressed = false;
                }, { passive: false });
            });
        }

        // Update HUD
        function updateScore() {
            document.getElementById('score').textContent = score;
        }

        function updateLives() {
            document.getElementById('lives').textContent = lives;
        }

        // Clean up on page unload
        window.addEventListener('beforeunload', () => {
            if (game) {
                game.destroy(true);
            }
        });
    </script>

    <style>
        #phaser-container {
            margin: 0 auto;
            width: fit-content;
            touch-action: manipulation;
        }

        #phaser-container canvas {
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
            border: 3px solid var(--color-text);
            box-shadow: 0 0 30px rgba(126, 200, 227, 0.4);
            touch-action: manipulation;
        }

        @media (max-width: 768px) {
            #phaser-container canvas {
                max-width: 95vw;
                max-height: 60vh;
            }
        }

        .control-actions {
            margin-top: 10px;
            text-align: center;
        }

        .control-actions button {
            min-width: 120px;
            font-size: 18px;
        }
        /* Center button in control-actions */
        .control-actions {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .restart-container {
            margin-top: 10px;
            text-align: center;
        }
    </style>

    <script src="../../../stars.js" defer></script>
</body>
</html>
